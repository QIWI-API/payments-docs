# Термины и сокращения {#articles}

**Ключ доступа к API** — Символьная строка для авторизации мерчанта в API согласно стандарту OAuth 2.0 [RFC 6749](https://tools.ietf.org/html/rfc6749) [RFC 6750](https://tools.ietf.org/html/rfc6750).

**Платежный токен** — Символьная строка, созданная по данным карты для безакцептных платежей.

**API**: Application Programming Interface — набор готовых методов, предоставляемых приложением (системой) для использования во внешних  программных продуктах.

**REST**: Representational State Transfer — архитектурный стиль взаимодействия компонентов распределённого приложения в сети.  

**JSON**: JavaScript Object Notation — текстовый формат обмена данными, основанный на JavaScript [RFC 7159](https://tools.ietf.org/html/rfc7159).

**3DS**: 3-D Secure — протокол защиты карточных данных, используемый для аутентификации держателя банковской карты во время совершения платежной операции через интернет. QIWI поддерживает как версию 3DS 1.0, так и версию 3DS 2.0 протокола.

**ТСП**, **Мерчант** — Торгово-сервисное предприятие.

**MPI**: Merchant Plug-In — модуль, выполняющий 3DS аутентификацию покупателя.  

**PCI DSS**: Payment Card Industry Data Security Standard — стандарт безопасности данных индустрии платёжных карт, учреждённым международными платёжными системами Visa, MasterCard, American Express, JCB и Discover.

# Начало работы {#start}

Чтобы начать работу с Протоколом, выполните следующие шаги.

**Шаг 1. Оставьте заявку на подключение [b2b.qiwi.com](https://b2b.qiwi.com)**

После обработки заявки менеджер Службы поддержки обсудит с вами возможные варианты подключения, соберет необходимые документы и запустит процесс интеграции.

<a name="auth"></a>

**Шаг 2. Получите доступ к личному кабинету**

При подключении к Протоколу приема платежей вы получаете уникальный идентификатор `siteId` и доступ в [Личный кабинет](https://kassa.qiwi.com/service/core/merchants?). Параметры доступа отправляются на указанный при регистрации email.

**Шаг 3. Выпустите ключ доступа к API**

Ключ доступа к API используется для взаимодействия с API. Выпустите ключ API в [Личном кабинете](https://kassa.qiwi.com/service/core/merchants?) в разделе **Настройки**.

**Шаг 4. Протестируйте взаимодействие**

При подключении ваш идентификатор находится в тестовом режиме. В этом режиме вы можете проводить  операции без списания средств с банковской карты. Подробнее о тестовом режиме см. в разделе [Тестовый режим](#test_mode).

Когда интеграция на вашей стороне закончена, мы переводим ваш идентификатор `siteId` в производственный режим. В производственном режиме выполняются реальные списания средств с карт.

# Способы подключения {#methods}

Протокол приема платежей поддерживает несколько вариантов взаимодействия:

* [Платеж через форму QIWI](#invoicing).
* [Платеж через форму мерчанта](#merchant-api-integration).

<aside class="warning">
Способ взаимодействия "Платеж через форму мерчанта" допускается только для PCI DSS сертифицированных мерчантов, т.к. прием и обработка карточных данных покупателей выполняется на стороне мерчанта.
</aside>

## Доступные методы оплаты {#payment-ways}

Метод|Платежная форма QIWI|Платежная форма мерчанта
-----|---------|--------------
Банковская карта*|✓|✓
Оплата платежным токеном | ✓ | ✓
Yandex Pay | × | ✓
Оплата через СБП | ✓ | ✓
Оплата с баланса КИВИ Кошелька | ✓ | ✓**
Оплата с баланса мобильного телефона | × | ✓

`*` — метод оплаты доступен по умолчанию, другие методы оплаты подключаются по запросу.

`**` — посредством [выпуска платежного токена для КИВИ кошелька](#merchant-form-wallet-token-issue).

## Типы операций {#operations}

В Протоколе доступны следующие операции:

* Счет (Invoice) — электронный документ, выставляемый продавцом покупателю. Содержит информацию о сумме и номере заказа. Не является финансовой сущностью и имеет ограниченный срок жизни. Выставление счета необходимо для получения ссылки на платежную форму QIWI.
* Платеж (Payment) — операция списания денежных средств от покупателя в пользу продавца. Фактическое списание происходит только после подтверждения (Capture). При работе через платежную форму QIWI, Payment — попытка оплаты счета (Invoice).
* Завершение (Complete) — завершение 3DS-верификации Покупателя. Используется при работе через Платежную форму мерчанта.
* Подтверждение (Capture) — операция подтверждения авторизации (списания) средств.
* Возврат (Refund) — возврат средств покупателю по успешному платежу. Финансовая операция списания денежных средств от продавца в пользу покупателя. Если подтверждения операции Payment не было, то в ответе на операцию Refund вы получите флаг Reversal и деньги со счета Покупателя на счет продавца не перечислятся (комиссия за эквайринг также не удерживается).

## Общая схема проведения платежа и взаиморасчетов {#principal-scheme}

<div class="mermaid">
sequenceDiagram
participant customer as Покупатель
participant store as Магазин мерчанта
participant ipsstore as Кредитная организация <br/> мерчанта
participant qb as QIWI
participant ips as Платежная система
participant ipscust as Кредитная организация <br/> Покупателя <br/> Эмитент или банк-отправитель
customer->>store:Старт оплаты
store->>qb:Платеж
qb->>ips:Авторизация платежа
ips->>ipscust:Авторизация платежа
rect rgb(255, 238, 223)
Note over ipsstore, ipscust:Взаиморасчеты
ipscust->>ips:₽₽₽
ips->>qb:₽₽₽
qb->>ipsstore:₽₽₽
end
</div>

# Формат взаимодействия {#api-format}

API Протокола приема платежей основано на принципах REST-архитектуры.

URL-адрес для вызова API:

`https://api.qiwi.com/partner/`

Методы API вызываются через HTTP-запросы. Параметры методов помещаются в JSON-тело запроса. В GET-запросах параметры помещаются в URL запроса.

API всегда возвращает ответ в формате JSON.

## Авторизация {#api-auth}

> Пример запроса с авторизацией

~~~shell
curl -X PUT https://api.qiwi.com/partner/v1/sites/{site_id}/payments/{payment_id} \
     --oauth2-bearer <Ключ API>
~~~

> Пример заголовка авторизации

~~~shell
Authorization: Bearer 5c4b25xx93aa435d9cb8cd17480356f9
~~~

Для авторизации запросов к API используется стандарт OAuth 2.0 согласно [RFC 6750](https://tools.ietf.org/html/rfc6750). Указывайте значение ключа доступа к API в HTTP-заголовке `Authorization` как

`Bearer <Ключ API>`

# Тестовый режим {#test_mode}

При подключении ваш идентификатор `siteId` находится в тестовом режиме. В этом режиме вы можете проводить операции без списания средств с банковской карты. Также можно запросить переключение в режим тестирования любого своего `siteId`, либо добавление нового `siteId` в режиме тестирования через вашего сопровождающего менеджера.

Для тестирования операций оплаты используются [URL протокола](#api-format).

**Тестовый режим для метода оплаты с баланса КИВИ Кошелька не предусмотрен**.

Когда интеграция на вашей стороне закончена, мы переводим `siteId` в производственный режим. В этом режиме выполняются реальные списания средств с карт.

**При переходе в производственный режим перевыпускать ключ доступа к API не нужно**.

При необходимости измените постоянный URL для обработки уведомлений с тестового (например, `https://your-shop-test.ru/callbacks`) на производственный (например, `https://your-shop-prod.ru/callbacks`) в [Личном кабинете](https://kassa.qiwi.com/service/core/merchants?).

<aside class="notice">
Ключ API, привязанный к <code>siteId</code>, действует для всех способов оплаты, подключенных к этому идентификатору.
</aside>

## Оплата картой в тестовом режиме {#test_data_card}

В тестовом режиме можно использовать любой номер карты, удовлетворяющий [алгоритму Luhn](https://en.wikipedia.org/wiki/Luhn_algorithm).

<h4>Тестовые номера карт</h4>
<h4 id="visa">
</h4>
<h4 id="mc">
</h4>
<button class="button-popup" id="generate">Получить номера карт</button>

В тестовом режиме из валют (параметр `currency`) разрешен только рубль РФ (`643`).

CVV в тестовом режиме может быть любым (произвольные 3 цифры).

Для тестирования различных вариантов оплаты и ответов необходимо использовать различные сроки действия карты:

* Если месяц срока действия — `02`, то операция будет проведена неуспешно.
* Если месяц срока действия — `03`, то операция будет проведена успешно с задержкой в 3 секунды.
* Если месяц срока действия — `04`, то операция будет проведена неуспешно с задержкой в 3 секунды.
* Во всех остальных случая операция выполняется успешно.

В тестовой среде установлено ограничение на сумму и количество тестовых операций. По умолчанию максимальная сумма тестовых транзакций — 10 рублей. Максимум — 100 транзакций в сутки (учитываются операции за текущие сутки, время по МСК). Учитываются операции с суммой не более установленного лимита.

Для проведения операции с 3DS необходимо использовать строку `unknown name` в имени держателя карты. Прохождение 3DS в режиме тестирования можно проверить только при вводе номера реальной карты.

## Оплата через СБП в тестовом режиме {#test_data_sbp}

Для тестирования различных вариантов оплаты и ответов указывайте разные суммы платежа (поле `amount`):

* `200` — операция пройдет успешно с задержкой. При первом [запросе статуса платежа](#payment_get) вы получите статус `"WAITING"`, после второго запроса статуса платежа — статус `"SUCCESS"`.
* Для других сумм платеж пройдет неуспешно.
