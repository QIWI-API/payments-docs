# Платеж через форму мерчанта {#merchant-api-integration}

<aside class="warning">
При интеграции со своей платежной формой вы отправляете в API запросы с полными номерами карт и кодом CVV/CVV2. Это допускается только при наличии PCI DSS сертификата у вашей организации. 

PCI DSS — стандарт информационной безопасности, принятый в индустрии платежных карт Visa и MasterCard. Соблюдать требования стандарта обязаны все компании, которые принимают карты к оплате.
</aside>

При подключении платежей через собственную платежную форму по умолчанию сразу доступен способ оплаты [Банковские карты](#qiwi-form-card). Другие способы оплаты доступны по запросу:

* [Платежные токены карт и QIWI Кошелька](#merchant-token-pay).
* [Apple Pay](#merchant-form-applepay).
* [Google Pay](#merchant-form-googlepay).
* [Yandex Pay](#merchant-form-yandexpay).
* [Система Быстрых Платежей (СБП)](#merchant-form-sbp).

## Процесс платежа {#flow-payment-merchant-form}

<div class="mermaid">
sequenceDiagram
participant customer as Покупатель
participant store as Магазин
participant qb as QIWI (эквайер)
participant ips as Эмитент
customer->>store:Выбор товаров, Старт оплаты,<br/>ввод платежных данных
activate store
store->>qb:Платеж<br/>Одношаговый платеж — все способы оплаты<br/>Двухшаговый платеж — только карты, Apple Pay, Google Pay
activate qb
qb->>store:Статус операции, данные для 3DS или QR-код СБП
rect rgb(237, 243, 255)
Note over customer, ips:3-D Secure
store->>customer:Переадресация покупателя на acsUrl или в приложение банка
activate ips
ips->>customer:Аутентификация покупателя:<br/>3DS — карты,<br/>СБП — подтверждение операции в интерфейсе эмитента карты
customer->>ips:Аутентификация
ips->>store:Результат аутентификации (PaRes)
store->>qb:Завершение аутентификации (complete)
end
qb->>ips:Запрос списания денежных средств
activate ips
ips->>qb:Статус операции
qb->>store:Уведомление о статусе операции
rect rgb(237, 243, 255)
Note over store, ips:Двухшаговый платеж
store->>qb:Подтверждение операции (capture)
qb->>ips:Подтверждение списания
deactivate ips
qb->>store:Уведомление о подтверждении платежа
end
deactivate qb
deactivate store
</div>

Чтобы создать платеж, передайте в запросе API [Платеж](#payments):

* ключ API;
* сумму платежа;
* метод платежа;
* другую информацию для создания платежа.

## Банковская карта {#merchant-form-card}

Протокол приема платежей поддерживает как двухшаговый платеж с холдированием средств на карте покупателя, так и одношаговый платеж без авторизации покупателя.

### Создание платежа {#merchant-form-hold}

>Пример платежа с холдированием (двухшаговый платеж)

~~~http
PUT /partner/payin/v1/sites/test-01/payments/1811 HTTP/1.1
Accept: application/json
Authorization: Bearer 5c4b25xx93aa435d9cb8cd17480356f9
Content-type: application/json
Host: api.qiwi.com

{
  "amount": {
    "currency": "RUB",
    "value": 1.00
  },
  "paymentMethod" : {
    "type" : "CARD",
    "pan" : "4444443616621049",
    "expiryDate" : "12/19",
    "cvv2" : "123",
    "holderName" : "unknown cardholder"
  }
}
~~~

>Пример платежа с немедленной оплатой (одношаговый платеж)

~~~http
PUT /partner/payin/v1/sites/test-01/payments/1811 HTTP/1.1
Accept: application/json
Authorization: Bearer 5c4b25xx93aa435d9cb8cd17480356f9
Content-type: application/json
Host: api.qiwi.com

{
  "amount": {
    "currency": "RUB",
    "value": 1.00
  },
  "paymentMethod" : {
    "type" : "CARD",
    "pan" : "4444443616621049",
    "expiryDate" : "12/19",
    "cvv2" : "123",
    "holderName" : "unknown cardholder"
  },
  "flags": [ "SALE" ]
}
~~~

Чтобы инициировать платеж с предварительным холдированием средств на карте (двухшаговый платеж), передайте в запросе API [Платеж](#payments):

* ключ API;
* сумму платежа;
* метод платежа `CARD` и карточные данные покупателя;
* другие данные для создания платежа.

В двухшаговом платеже [возмещение](#reimburse) формируется только после [подтверждения платежа](#merchant-capture).

<a name="one-step"></a>

<aside class="notice">
По умолчанию, при холдировании сервис QIWI ожидает <a href="#merchant-capture">подтверждения платежа</a> в течение 72 часов. По истечении срока выполняется автоподтверждение платежа. Чтобы увеличить или уменьшить период ожидания, или настроить автоотмену платежа обратитесь в службу поддержки. Период ожидания не может длиться более 5 суток.
</aside>

Для платежа без авторизации (одношаговый платеж) укажите в запросе API [Платеж](#payments) параметр `"flags":["SALE"]`. Если не передать этот параметр, то будет выполнено безусловное холдирование средств для выполнения платежа.

### Ожидание аутентификации покупателя (3-D Secure) {#merchant-threeds}

>Пример ответа с требованием аутентификации покупателя

~~~json
{
    "paymentId": "1811",
    "billId": "autogenerated-a29ea8c9-f9d9-4a60-87c2-c0c4be9affbc",
    "createdDateTime": "2019-08-15T13:28:26+03:00",
    "amount": {
        "currency": "RUB",
        "value": 1.00
    },
    "capturedAmount": {
        "currency": "RUB",
        "value": 0.00
    },
    "refundedAmount": {
        "currency": "RUB",
        "value": 0.00
    },
    "paymentMethod": {
        "type": "CARD",
        "maskedPan": "444444******1049",
        "rrn": "123",
        "authCode": "181218",
        "type": "CARD"
    },
    "status": {
        "value": "WAITING",
        "changedDateTime": "2019-08-15T13:28:26+03:00"
    },
    "requirements" : {
        "threeDS" : {
          "pareq" : "eJyrrgUAAXUA+Q==",
          "acsUrl" : "https://test.paymentgate.ru/acs/auth/start.do"
        }
    }
}
~~~

> Перенаправление для аутентификации 3-D Secure

~~~html
<form name="form" action="{ACSUrl}" method="post" >
        <input type="hidden" name="TermUrl" value="{TermUrl}" >
        <input type="hidden" name="MD" value="{MD}" >
        <input type="hidden" name="PaReq" value="{PaReq}" >
</form>
~~~

> Завершение аутентификации покупателя

~~~http
POST /partner/payin/v1/sites/test-01/payments/1811/complete HTTP/1.1
Accept: application/json
Authorization: Bearer 5c4b25xx93aa435d9cb8cd17480356f9
Content-type: application/json
Host: api.qiwi.com

{
  "threeDS": {
    "pares": "eJzVWFevo9iyfu9fMZrzaM0QjWHk3tIiGptgooE3cgabYMKvv3jvTurTc3XOfbkaJMuL...."
  }
}
~~~

Если требуется 3DS аутентификация покупателя, понадобится пройти дополнительную проверку у эмитента. В этом случае в ответе на запрос платежа добавляется объект `requirements.threeDS` с полями:

- `acsUrl` — URL сервера аутентификации 3-D Secure, для перенаправления на страницу подтверждения от эмитента;
- `pareq` — зашифрованный запрос на аутентификацию 3-D Secure.

Чтобы получить результат проверки (`PaReS`), сделайте POST-запрос на URL сервера аутентификации 3-D Secure с параметрами:

- `TermUrl` — URL перенаправления покупателя после успешной аутентификации 3-D Secure;
- `MD` — уникальный идентификатор транзакции;
- `PaReq` — значение параметра `pareq` из ответа на платежный запрос.

Чтобы сохранять обратную совместимость, использование протокола 3-D Secure 1.0 или 3-D Secure 2.0 не влияет на вашу интеграцию с API.

Информация о покупателе передаётся в платежную систему карты. Банк-эмитент либо предоставляет разрешение на списание средств без аутентификации (frictionless flow), либо принимает решение о необходимости аутентификации с помощью одноразового пароля (challenge flow). После прохождения проверки покупатель перенаправляется по адресу `TermUrl` с зашифрованным результатом проверки в параметре `PaRes`.

Чтобы завершить аутентификацию покупателя, передайте в запросе API [Завершение аутентификации клиента](#payment_complete):

* уникальный ID мерчанта;
* номер платежа (параметр `paymentId`) из ответа на запрос платежа;
* результат 3-D Secure (значение параметра `PaRes`).

### Подтверждение платежа {#merchant-capture}

>Пример уведомления

~~~json
{
  "payment":{
    "paymentId":"804900",  <==paymentId, необходимый для подтверждения
    "type":"PAYMENT",
    "createdDateTime":"2020-11-28T12:58:49+03:00",
    "status":{
        "value":"SUCCESS",
        "changedDateTime":"2020-11-28T12:58:53+03:00"
    },
    "amount":{
      "value":100.00,
      "currency":"RUB"
    },
    "paymentMethod":{
      "type":"CARD",
      "maskedPan":"444444XXXXXX4444",
      "rrn":null,
      "authCode":null,
      "type":"CARD"
    },
    "customer":{
      "phone":"75167693659"
    },
    "gatewayData":{
      "type":"ACQUIRING",
      "eci":"6",
      "authCode":"181218"
    },
    "billId":"autogenerated-a51d0d2c-6c50-405d-9305-bf1c13a5aecd",
    "flags":[]
  },
  "type":"PAYMENT",
  "version":"1"
}
~~~

>Подтверждение платежа

~~~http
PUT /partner/payin/v1/sites/{siteId}/payments/804900/capture/bxwd8096 HTTP/1.1
Accept: application/json
Authorization: Bearer 5c4b25xx93aa435d9cb8cd17480356f9
Content-type: application/json
Host: api.qiwi.com
~~~

Это действие требуется только для двухшагового платежа с холдированием.

Чтобы подтвердить платеж:

* Получите `paymentId` платежа:
     * Из [серверного уведомления](#payment-callback) после успешного холдирования средств.
     * Из отета на запрос [Статус платежа](#payment_get).
* Отправьте запрос API [Подтверждение платежа](#capture) с полученным `paymentId`.

## Платежный токен {#merchant-token-pay}

>Использование платежного токена в запросе платежа

~~~http
PUT /partner/payin/v1/sites/test-02/payments/1815 HTTP/1.1
Accept: application/json
Authorization: Bearer 7uc4b25xx93xxx5d9cb8cd17480356f9
Content-type: application/json
Host: api.qiwi.com

{
  "amount": {
    "currency": "RUB",
    "value": 2000.00
  },
  "paymentMethod" : {
    "type": "TOKEN",
    "paymentToken" : "66aebf5f-098e-4e36-922a-a4107b349a96"
  },
  "customer": {
        "account": "token324"
  }
}
~~~

Платежные токены используются для списаний с карт или QIWI кошельков без ввода реквизитов карты или номера кошелька. Метод оплаты платежным токеном по умолчанию отключен. Чтобы подключить его, обратитесь к вашему сопровождающему менеджеру.

О выпуске платежного токена читайте [в разделе по ссылке](#payment-token-issue).

<aside class="warning">
Покупатель может совершать оплату платежным токеном только на том сайте, для которого был выпущен платежный токен.

Чтобы платежный токен действовал на других сайтах, отправьте запрос в Службу поддержки.
</aside>

Чтобы оплатить покупку платежным токеном, передайте в запросе API [Платеж](#payment):

* платежный токен в объекте `paymentMethod`,
* идентификатор покупателя, для которого был выпущен платежный токен, в параметре `customer.account`.

Параметр|Тип|Описание
--------|---|--------
paymentMethod.type|String|Тип операции. Только `TOKEN`
paymentMethod.paymentToken|String| Строка платежного токена
customer.account|String|Уникальный идентификатор Покупателя в системе ТСП, для которого выпущен платежный токен. **Без данного параметра оплата платежным токеном невозможна.**

Покупатель не будет указывать свои карточные данные и проходить проверку 3-D Secure.

## Apple Pay {#merchant-form-applepay}

Оплата покупок с Apple Pay происходит без ввода данных карты. Технология работает в мобильных приложениях и браузере Safari на iPhone, iPad, Apple Watch и MacBook.

Для включения способа оплаты Apple Pay обратитесь к вашему сопровождающему менеджеру.

Для интеграции Apple Pay на Платежную страницу мерчанта понадобится выполнить интеграцию с Apple. Это позволит верифицировать сайт мерчанта и получать платежные данные покупателя. Требования для интеграции Apple Pay на веб-странице:

* Аккаунт разработчика в Apple Developer Program.
* Использование HTTPS на странице с Apple Pay, поддержка TLS 1.2, действительный SSL сертификат.
* Соблюдение [правил Apple](https://developer.apple.com/apple-pay/acceptable-use-guidelines-for-websites/) по использованию Apple Pay на сайтах.
* Использование фреймворка [Apple Pay JS API](https://developer.apple.com/documentation/apple_pay_on_the_web/apple_pay_js_api).

Подробнее об интеграции см. [на сайте Apple](https://developer.apple.com/apple-pay/implementation/).

### Процесс платежа {#merchant-form-applepay-steps}

Процесс выполнения платежа Apple Pay в API:

 1. Создание платежной сессии Apple Pay.
 2. Валидация ТСП в Apple Pay.
 3. Получение зашифрованных платежных данных от Apple Pay.
 4. Расшифровка платежных данных (опционально).
 5. Отправка запроса на списание средств в QIWI:
     * [с зашифрованными данными](#merchant-form-applepay-encrypted),
     * [с расшифрованными данными](#merchant-form-applepay-decrypted) (Если платежный токен Apple расшифрован на стороне ТСП).

### Как отправлять платеж с зашифрованными данными {#merchant-form-applepay-encrypted}

> Пример JSON-объекта 'paymentMethod' для платежа Apple Pay

~~~json
"paymentMethod": {
  "type": "APPLE_PAY_TOKEN",
  "paymentData": {
    "version":"EC_v1",
    "data":"IaD7LKDbJsOrGTlNGkKUC95Y+4an2YuN0swstaCaoovlj8dbgf16FmO5j4AX80L0xsRQYKLUpgUHbGoYF26PbraIdZUDtPtja4HdqDOXGESQGsAKCcRIyujAJpFv95+5xkNldDKK2WTe28lHUDTA9bykIgrvasYaN9VWnS92i2CZPpsI7yu13Kk3PrUceuA3Fb6wFgJ0l7HXL1RGhrA7V5JKReo/EwikMsK8AfChK7pvWaB51SsMvbMJF28JnincfVX39vYHdzEwpjSPngNiszGqZGeLdqNE3ngkoEK1AW2ymbYkIoy9KFdXayekELR6hQWnL4MCutLesLjKhyTN26fxBamPHzAf/IczAdWBDq2P/59jheIGrnK30slJJcr1Bocb8rqojyaVZIY+Xk24Nc6dvSdJhfDDyhX56pn5YtWOxWuVOT0tZSJvxBN/HeIuYcNG6R9u7CHpcelsi4I8O+1gruKKZQHweERG2DyCmoUO9zlajOSm",
    "header": {
       "ephemeralPublicKey":"MFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAEzLx7FJhw1Z1PmxOLMTQBs1LgKEUT6 hcxLlT8wGrzwyY8tKeG+VPSjryVkTFYECrj+5r28PJWtmvn/unYhbYDaQ==",
       "publicKeyHash":"OrWgjRGkqEWjdkRdUrXfiLGD0he/zpEu512FJWrGYFo=",
       "transactionId":"1234567890ABCDEF"
     },
    "signature":"ZmFrZSBzaWduYXR1cmU="
  }
}
~~~

Для отправки платежных данных в QIWI передайте в запросе API [Платеж](#payments) объект `paymentMethod` с параметрами:

* `type` — тип платежного метода, только `APPLE_PAY_TOKEN`.
* `paymentData` — платежный токен (обязательное поле). Данные в `paymentData` берутся из поля `paymentData` платежного токена (см. [описание JSON-структуры токена](https://developer.apple.com/library/archive/documentation/PassKit/Reference/PaymentTokenJSON/PaymentTokenJSON.html)):
	* `version` — информация о версии платежного токена. Возможные значения: `EC_v1`, `RSA_v1` (обязательное поле);
	* `data` — зашифрованные платежные данные, Base64-строка (обязательное поле);
	* `header` — дополнительная информация, используемая для дешифровки и валидации платежа (обязательное поле):
	  * `applicationData` — SHA-256-хэш поля `applicationData` исходного платежного токена, HEX-строка (необязательное поле);
	  * `ephemeralPublicKey` — массив байтов эфемерного публичного ключа, закодированный в виде Base64-строки (используется только когда `version=EC_v1`);
	  * `wrappedKey` — симметричный ключ на основе публичного RSA-ключа, закодированный в виде Base64-строки (используется только когда `version=RSA_v1`);
	  * `publicKeyHash` — SHA-256-хэш от массива байт публичного ключа сертификата мерчанта, Base64-строка (обязательное поле);
	  * `transactionId` — идентификатор транзакции, генерируемый на устройстве, где выполняется платёж. HEX-идентификатор, представленный в виде строки (обязательное поле);
	* `signature` — подпись, вычисленная по платежному токену, Base64-строка (обязательное поле).

### Как отправлять платеж с расшифрованными данными {#merchant-form-applepay-decrypted}

> Пример отправки расшифрованных платежных данных Apple Pay

~~~json
"paymentMethod": {
  "type": "CARD",
  "pan": "4444443616621049",
  "expiryDate": "12/19",
  "holderName": "Apple Pay",
  "external3dSec": {
    "type": "APPLE_PAY",
    "onlinePaymentCryptogram": "AOLqt9wP++/WAzN+is7YAoABFA==",
    "eciIndicator": "05"
  }
}
~~~

Используйте этот способ, если платежный токен Apple расшифрован на вашей стороне.

Для отправки платежных данных в QIWI передайте в запросе API [Платеж](#payments) параметры в объекте `paymentMethod`:

* `type` — всегда `CARD`;
* данные из расшифрованного платежного токена Apple:
   * PAN в поле `"pan"`;
   * срок действия в формате `MM/YY` в поле `"expiryDate"`;
* объект `external3dSec` с элементами:
   * `type` — всегда `APPLE_PAY`;
   * `onlinePaymentCryptogram` — содержимое поля `onlinePaymentCryptogram` платежного токена Apple (Base64-закодированная строка);
   * `eciIndicator` — ECI индикатор. Необходимо передавать, если поле `eciIndicator` получено в платежном токене Apple. В противном случае параметр не передавать.

## Google Pay {#merchant-form-googlepay}

В способе оплаты Google Pay™ поддерживаются платежи с карт Visa и MasterCard.

Для включения способа оплаты Google Pay™ обратитесь к вашему сопровождающему менеджеру.

Процесс интеграции Google Pay™ на платежную страницу мерчанта:

1. Выполните требования [Google Pay™ WEB](https://developers.google.com/pay/api/web) для приема шифрованных платежных данных. В том числе, проверьте [контрольный список интеграции Google Pay™ для веб-сайтов](https://developers.google.com/pay/api/web/guides/test-and-deploy/integration-checklist) и [правила фирменного оформления Google Pay™ для веб-сайтов](https://developers.google.com/pay/api/web/guides/brand-guidelines).
2. Для интеграции необходимо выполнить требования к отправке данных:
    * [с зашифрованными данными](#merchant-form-googlepay-encrypted),
    * [с расшифрованными данными](#merchant-form-googlepay-decrypted).
3. Подайте [заявку на доступ к рабочей версии](https://developers.google.com/pay/api/web/guides/test-and-deploy/request-prod-access). В заявке на доступ укажите следующие данные:
    * Tokenization Method — Gateway;
    * Payment Processor or Gateway — `qiwi`;
    * Merchant Name — выдается технической поддержкой компании QIWI.
4. Google проверит работу вашей платежной формы в рабочей среде и даст одобрение на запуск.

### Как отправлять платеж с зашифрованными данными {#merchant-form-googlepay-encrypted}

> Пример объекта `paymentMethod`

~~~json
"paymentMethod": {
    "type": "GOOGLE_PAY_TOKEN",
    "paymentToken": "eJxVUtuK2zAQfd+vCHGShS9mS0hb8YChjabx……"
    }
~~~

> Пример шифрования/проверки токена для Google Pay

~~~python
import zlib
import base64

token = 'Hello world'

token_bytes = token.encode('utf-8')
token_deflated = zlib.compress(token_bytes)
token_base64 = base64.b64encode(token_deflated)
token_result = token_base64.decode('utf-8')

resp_base64 = token_result.encode('utf-8')
resp_deflated = base64.b64decode(resp_base64)
resp_bytes = zlib.decompress(resp_deflated)
resp_token = resp_bytes.decode('utf-8')

print('resp_token: ', resp_token)
~~~

~~~shell
>> resp_token: 'Hello world'
~~~

Отправьте платежные данные в QIWI. Для этого передайте в запросе API [Платеж](#payments) параметры в объекте `paymentMethod`:

* `paymentMethod.type=GOOGLE_PAY_TOKEN`
* `paymentMethod.paymentToken`, заполненный по следующему алгоритму:

   `b64_encode_bytes_to_string (compress_bytes_with_zlib (to_bytes (JSON)))`

  Шаг 1 (`to_bytes`) — Объект JSON конвертируется в массив байтов в соответствии с кодировкой UTF-8. **Структура объекта JSON описана в [руководстве по криптографии платежных данных Google](https://developers.google.com/pay/api/web/guides/resources/payment-data-cryptography)**.

  Шаг 2 (`compress_bytes_with_zlib`) — Байты, полученные на предыдущем шаге, сжимаются с помощью библиотеки zlib. При выполнении сжатия необходимо следовать спецификации [RFC1950](http://www.ietf.org/rfc/rfc1950.txt) и обеспечить запись zlib header в начало потока со сжатыми данными.

  Шаг 3 (`b64_encode_bytes_to_string`) — Байты, полученные на предыдущем шаге, кодируются в формат base64.

Полученная в результате закодированная строка является значением поля `paymentToken`.

### Как отправлять платеж с расшифрованными данными {#merchant-form-googlepay-decrypted}

> Пример платежа с данными расшифрованного платежного токена Google Pay (метод CRYPTOGRAM_3DS)

~~~json
{
  "paymentMethod": {
    "type": "CARD",
    "pan": "4444443616621049",
    "expiryDate": "12/19",
    "holderName": "Google Pay",
    "external3dSec": {
      "type": "GOOGLE_PAY",
      "cryptogram": "AOLqt9wP++YAoABFA==",
      "eciIndicator": "05"
    }
  },
  "amount": {
    "value": 5900.00,
    "currency": "RUB"
  },
  "flags": [
    "SALE"
  ],
  "customer": {
    "account": "79111111111",
    "email": "test@qiwi.com",
    "phone": "79111111111"
  }
}
~~~

> Пример платежа с данными расшифрованного платежного токена Google Pay (метод PAN_ONLY)

~~~json
{
  "paymentMethod": {
    "type": "CARD",
    "pan": "4444443616621049",
    "expiryDate": "12/19",
    "holderName": "Google Pay",
    "external3dSec": {
      "type": "GOOGLE_PAY"
    }
  },
  "amount": {
    "value": 760.00,
    "currency": "RUB"
  },
  "flags": [
    "SALE"
  ],
  "customer": {
    "account": "11111",
    "email": "test@qiwi.com",
    "phone": "79111111111"
  }
}
~~~

При отправке платежа с расшифрованным платежным токеном Google, формат платежных данных зависит от способа аутентификации, указанного в поле `authMethod` токена:

* `CRYPTOGRAM_3DS`. Без дополнительной аутентификации покупателя.
  
  Для отправки платежных данных в QIWI передайте в запросе API [Платеж](#payments) объект `paymentMethod` с параметрами:

  * `type` — всегда `CARD`;
  * данные из расшифрованного платежного токена Google:
     * PAN в поле `"pan"`;
     * срок действия в формате `MM/YY` в поле `"expiryDate"`;
     * объект `external3dSec` с элементами:
       * `type` — всегда `GOOGLE_PAY`;
       * `cryptogram` — содержимое поля `cryptogram` платежного токена Google(Base64-закодированная строка);
       * `eciIndicator` — ECI индикатор. Необходимо передавать, если поле `eciIndicator` получено в платежном токене Google. В противном случае параметр не передавать.

* `PAN_ONLY`. С дополнительной аутентификацией покупателя (3-D Secure).
  
  Для отправки платежных данных в QIWI передайте в запросе API [Платеж](#payments) объект `paymentMethod` с параметрами:

  * `type` — всегда `CARD`;
  * данные из расшифрованного платежного токена Google:
     * PAN в поле `"pan"`;
     * срок действия в формате `MM/YY` в поле `"expiryDate"`;
     * объект `external3dSec` с полем `type`, всегда равным `GOOGLE_PAY`.

## Yandex Pay {#merchant-form-yandexpay}

Оплата покупок с Yandex Pay происходит без ввода данных карты.

Для включения способа оплаты Yandex Pay обратитесь к вашему сопровождающему менеджеру.

### Как отправлять платеж {#merchant-form-yandexpay-payment}

> Пример платежа с данными расшифрованного платежного токена Yandex Pay (метод CLOUD_TOKEN)

~~~json
{
  "paymentMethod": {
    "type": "CARD",
    "pan": "4444443616621049",
    "expiryDate": "12/19",
    "holderName": "Yandex Pay",
    "external3dSec": {
      "type": "YANDEX_PAY",
      "cryptogram": "AOLqt9wP++YAoABFA==",
      "eciIndicator": "05"
    }
  },
  "amount": {
    "value": 5900.00,
    "currency": "RUB"
  },
  "flags": [
    "SALE"
  ],
  "customer": {
    "account": "79111111111",
    "email": "test@qiwi.com",
    "phone": "79111111111"
  }
}
~~~

> Пример платежа с данными расшифрованного платежного токена Yandex Pay (метод PAN_ONLY)

~~~json
{
  "paymentMethod": {
    "type": "CARD",
    "pan": "4444443616621049",
    "expiryDate": "12/19",
    "holderName": "Yandex Pay",
    "external3dSec": {
      "type": "YANDEX_PAY"
    }
  },
  "amount": {
    "value": 760.00,
    "currency": "RUB"
  },
  "flags": [
    "SALE"
  ],
  "customer": {
    "account": "11111",
    "email": "test@qiwi.com",
    "phone": "79111111111"
  }
}
~~~

При отправке платежа, формат платежных данных зависит от способа аутентификации, указанного в поле `authMethod` расшифрованного платежного токена Yandex Pay:

* `CLOUD_TOKEN`. Без дополнительной аутентификации покупателя.
  
  Для отправки платежных данных в QIWI передайте в запросе API [Платеж](#payments) объект `paymentMethod` с параметрами:

  * `type` — всегда `CARD`;
  * данные из расшифрованного платежного токена Yandex Pay:
     * PAN в поле `"pan"`;
     * срок действия в формате `MM/YY` в поле `"expiryDate"`;
     * объект `external3dSec` с элементами:
       * `type` — всегда `YANDEX_PAY`;
       * `cryptogram` — содержимое поля `cryptogram` платежного токена Yandex Pay(Base64-закодированная строка);
       * `eciIndicator` — ECI индикатор. Необходимо передавать, если поле `eciIndicator` получено в платежном токене Yandex Pay. В противном случае параметр не передавать.

* `PAN_ONLY`. С дополнительной аутентификацией покупателя (3-D Secure).
  
  Для отправки платежных данных в QIWI передайте в запросе API [Платеж](#payments) объект `paymentMethod` с параметрами:

  * `type` — всегда `CARD`;
  * данные из расшифрованного платежного токена Yandex Pay:
     * PAN в поле `"pan"`;
     * срок действия в формате `MM/YY` в поле `"expiryDate"`;
     * объект `external3dSec` с полем `type`, всегда равным `YANDEX_PAY`.

## Оплата через СБП {#merchant-form-sbp}

**Протокол приема платежей** поддерживает списание средств с покупателя через [Систему быстрых платежей](https://sbp.nspk.ru/) (СБП). Через СБП можно выполнять платежи в пользу юридических лиц, в том числе с использованием QR-кодов.

По умолчанию прием оплаты через СБП отключен. Чтобы подключить этот способ оплаты, обратитесь к вашему сопровождающему менеджеру.

### Получение QR-кода {#qr-sbp}

> Пример тела запроса для платежа через СБП

~~~json
{
  "amount": {
    "value": 100.00,
    "currency": "RUB"
  },
  "qrCode": {
    "type": "DYNAMIC",
    "ttl": 999,
    "image": {
      "mediaType": "image/png",
      "width": "300",
      "height": "300"
    }
  },
  "paymentPurpose": "Flower for my girlfriend",
  "redirectUrl": "http://someurl.com"
}
~~~

> Пример ответа c QR-кодом

~~~json
{
  "qrCodeUid": "adghj17d1g8",
  "amount": {
    "value": 100.00,
    "currency": "RUB"
  },
  "paymentPurpose": "Flower for my girlfriend",
  "redirectUrl": "http://someurl.com",
  "qrCode": {
    "type": "DYNAMIC",
    "ttl": 999,
    "status": "CREATED",
    "payload": "https://qr.nspk.ru/AD10006B89A9QD8FLUT1HEMP1?type=02&sum=405&cur=RUB&crc=5C01D",
    "image": {
      "content": "iVBORw0KgAAA5fY51AAAR+..",
      "mediaType": "image/png",
      "width": "300",
      "height": "300"
    }
  },
  "payment": {
    "paymentUid": "12s1s21",
    "paymentStatus": "WAITING"
  }
}
~~~

Чтобы покупатель смог произвести оплату через СБП, выпустите QR-код. Для этого отправьте запрос API [Получение QR-кода СБП](#qr-code-sbp). В запросе укажите:

* Объект `qrCode` с характеристиками запрашиваемого QR-кода:
   * Тип QR-кода в параметре `qrCode.type`:
     * `DYNAMIC` — динамический QR-код, индивидуальный для каждой оплаты.
     * `STATIC` — статический QR-код, формируется один раз, удобно для товаров с фиксированной ценой.
   * Срок действия кода в минутах в параметре `qrCode.ttl`. Указывается только для `qrCode.type=DYNAMIC`. По умолчанию динамический QR-код активен в течение 72 часов, по истечении срока деактивируется.
   * Тип и размер изображения QR-кода в блоке `qrCode.image`.
* Сумму платежа.
* Чтобы добавить описание платежа, используйте поле запроса `paymentPurpose`. Если это поле не заполнено, в приложении банка покупателя отобразится название вашего магазина.

В ответе на запрос в объекте `qrCode` содержатся данные QR-кода:

* `image.content` — base64-encoded QR-код. После расшифровки вы получите изображение для отображения покупателю.
* `payload` — URL-based QR для перенаправления покупателя в приложение банка.

### Статус платежа через СБП {#sbp-status}

После оплаты платеж перейдет в финальный статус. Актуальный статус платежа по идентификатору `paymentUid` можно [получить через API](#payment_get).

### Статус QR-кода {#qr-code-status}

> Пример ответа на запрос статуса QR-кода

~~~json
{
  "qrCodeUid": "adghj17d1g8",
  "amount": {
    "value": 1.00,
    "currency": "RUB"
  },
  "paymentPurpose": "Flower for my girlfriend",
  "redirectUrl": "http://someurl.com",
  "qrCode": {
    "type": "DYNAMIC",
    "ttl": 999,
    "status": "CREATED",
    "payload": "",
    "image": {
      "content": "Base64 string",
      "mediaType": "image/png",
      "width": "300",
      "height": "300"
    }
  },
  "payment": {
    "paymentUid": "12s1s21",
    "paymentStatus": "WAITING"
  }
}
~~~

Используйте запрос [Статус QR-кода СБП](#qr-code-sbp-get). В ответе возвращается информация о QR-коде, в том числе его текущий статус. Так вы можете определить действует ли QR-код.

### Выпуск токена для оплаты через СБП {#merchant-form-token-issue-sbp}

> Пример тела запроса выпуска токена СБП

~~~json
{
  "qrCodeUid": "adghj17d1g8",
  "amount": {
    "value": 100.00,
    "currency": "RUB"
  },
  "qrCode": {
    "type": "TOKEN",
    "image": {
        "mediaType": "image/png",
        "width": "300",
        "height": "300"
      }
  },
  "tokenizationPurpose": "",
  "tokenizationAccount": "3e2322",
  "flags": ["CREATE_TOKEN"]
}
~~~

Вы можете выпустить платежный токен СБП для привязки карты покупателя и [последующих оплат через СБП](#token-sbp-payment).

Чтобы выпустить платежный токен, воспользуйтесь запросом [Получение QR-кода СБП](#qr-code-sbp). В запросе укажите:

* Объект `qrCode` с характеристиками запрашиваемого QR-кода:
   * Тип QR-кода в параметре `qrCode.type` — `TOKEN`.
   *  Тип и размер изображения QR-кода в блоке `qrCode.image`.
* Сумму платежа.
* Параметр `tokenizationAccount` — уникальный идентификатор Покупателя в системе ТСП.
* Параметр `"flags":["CREATE_TOKEN"]`.
* Описание токена в параметре `tokenizationPurpose`.

**Необходимо использовать разные параметры `tokenizationAccount` для разных покупателей, чтобы гарантировать безопасность привязанных карточных данных покупателей.**

Вы получите информацию о платежном токене СБП в объекте `token` ответа.

<aside class="notice">
Платежный токен будет связан с идентификатором сайта и идентификатором Покупателя, которые вы указали в запросе API.
</aside>

### Оплата токеном через СБП {#token-sbp-payment}

> Пример тела запроса

~~~json
{
  "tokenizationAccount": "customer123",
  "token": "c5ba4a05-21c9-4a36-af7a-b709b4caa4d6"
}
~~~

<aside class="warning">
Покупатель может совершать оплату платежным токеном только на том сайте, для которого был выпущен платежный токен.

Чтобы платежный токен действовал на других сайтах, отправьте запрос в Службу поддержки.
</aside>

Чтобы оплатить покупку платежным токеном СБП, передайте в запросе API [Платеж токеном СБП](#payment-sbp-token):

* платежный токен в параметре `token`,
* идентификатор покупателя, для которого был выпущен платежный токен, в параметре `tokenizationAccount`.
