# Платежный токен {#payment-token-issue}

В **Протоколе приема платежей** поддерживается генерация платежных токенов карт и QIWI Кошельков. Они могут быть использованы для последующих списаний без дополнительного ввода реквизитов карт или номера кошелька. При выпуске платежного токена карты ее реквизиты сохраняются в зашифрованном виде в QIWI.

## Особенности {#payment-token-special}

По умолчанию выпуск платежных токенов отключен. Чтобы подключить его, обратитесь к вашему сопровождающему менеджеру.

<aside class="warning">Платежный токен карты выпускается только после успешной авторизации платежа банком-эмитентом.</aside>

## Выпуск платежного токена карты {#merchant-form-token-issue}

>Пример запроса выставления счета с выпуском платежного токена

~~~http
PUT /partner/payin/v1/sites/23044/bills/893794793973 HTTP/1.1
Accept: application/json
Authorization: Bearer 5c4b25xx93aa435d9cb8cd17480356f9
Content-type: application/json
Host: api.qiwi.com

{
   "amount": {  
     "currency": "RUB",  
     "value": 10.00
   },
   "expirationDateTime": "2021-04-13T14:30:00+03:00",
    "customer": { 
      "account":"token32" 
   }, 
   "customFields": {}, 
   "flags":["BIND_PAYMENT_TOKEN"] 
} 
~~~

>Пример запроса платежа с выпуском платежного токена

~~~http
PUT /partner/payin/v1/sites/test-01/payments/test-022 HTTP/1.1
Accept: application/json
Authorization: Bearer 5c4b25xx93aa435d9cb8cd17480356f9
Content-type: application/json
Host: api.qiwi.com

{
   "amount": {  
     "currency": "RUB",  
     "value": 2211.24
   },
   "customer": {
     "account": "token324",
     "phone": "79022222222"
   },
   "flags":["BIND_PAYMENT_TOKEN"]
}
~~~

> Пример тела ответа с платежным токеном

~~~json
{
    "paymentId": "test-022",
    "billId": "autogenerated-c4479bb1-c916-4fba-8445-802592fa8d51",
    "createdDateTime": "2020-03-26T12:22:12+03:00",
    "amount": {
        "currency": "RUB",
        "value": 2211.24
    },
    "capturedAmount": "..",
    "refundedAmount": "..",
    "paymentMethod": "..",
    "createdToken": {
        "token": "66aebf5f-098e-4e36-922a-a4107b349a96",
        "name": "411111******1111"
    },
    "customer": {
        "account": "token324",
        "phone": "79022222222"
    },
    "status": ".."
}
~~~

Чтобы выпустить платежный токен карты, укажите в запросах API [Платеж](#payments) или [Создание счета](#invoice_put) дополнительные параметры:

* `"flags": ["BIND_PAYMENT_TOKEN"]` — команда для выпуска платежного токена.
* `customer.account` — уникальный идентификатор Покупателя в системе ТСП. **Указывайте разные параметры `account` для разных пользователей, чтобы гарантировать безопасность карточных данных покупателей.**

Вы получите информацию о платежном токене карты:

* В синхронном ответе на запрос API  [Платеж](#payments) (поле `createdToken`).
* После успешного завершения платежа в [уведомлении](#payment_callback) (поле `tokenData`).

Также вы можете выпустить платежный токен карты с помощью запроса API [Проверка карты](#card-check-api). Укажите в нем блок `tokenizationData.account` с уникальным идентификатором Покупателя в системе ТСП. **Указывайте разные параметры `account` для разных пользователей, чтобы гарантировать безопасность карточных данных покупателей.**

Вы получите информацию о платежном токене карты после успешного [завершения проверки](#how-to-check-card) в блоке `createdToken`.

<aside class="warning">
Платежный токен будет связан с идентификатором сайта и идентификатором Покупателя, которые вы указали в запросе платежа. Покупатель сможет совершать оплату платежным токеном только на этом сайте.

Чтобы платежный токен действовал на других сайтах одного мерчанта, отправьте запрос в Службу поддержки.
</aside>


## Выпуск платежного токена QIWI Кошелька {#merchant-form-wallet-token-issue}

>Пример запроса с инициацией выпуска платежного токена QIWI Кошелька

~~~http
POST /partner/payin/v1/sites/test-01/token-requests HTTP/1.1
Accept: application/json
Authorization: Bearer 5c4b25xx93aa435d9cb8cd17480356f9
Content-type: application/json
Host: api.qiwi.com

{
   "requestId": "asd1232q77w1e3212",
   "phone": "79022222222",
   "accountId": "token324"
}
~~~

> Ответ на запрос

~~~json
{
    "requestId": "asd1232q77w1e3212",
    "status": {
        "value": "WAITING_SMS"
    }
}
~~~

>Пример запроса завершения выпуска платежного токена QIWI Кошелька

~~~http
PUT /partner/payin/v1/sites/test-01/token-requests/complete HTTP/1.1
Accept: application/json
Authorization: Bearer 5c4b25xx93aa435d9cb8cd17480356f9
Content-type: application/json
Host: api.qiwi.com

{
   "requestId": "asd1232q77w1e3212",
   "smsCode": "1223"
}
~~~

> Ответ на запрос

~~~json
{
    "requestId": "asd1232q77w1e3212",
    "status": {
        "value": "CREATED"
    },
    "token": {
        "value": "589c04b5-47dd-41af-9682-b3eb91",
        "expiredDate": "2021-11-08T14:23:54+03:00"
    }
}
~~~

Чтобы выпустить платежный токен QIWI кошелька, выполните следующие запросы к API:

1. Запрос инициации выпуска платежного токена QIWI Кошелька.
  
    Отправьте POST-запрос на URL:

    `/partner/payin/v1/sites/{siteId}/token-requests`

    где `{siteId}` — идентификатор siteId мерчанта.

    В JSON-теле запроса укажите параметры:

    * `requestId` — уникальный идентификатор запроса (от 1 до 36 символов). Уникальность означает, что идентификатор должен отличаться от идентификаторов всех ранее созданных запросов ТСП на выпуск платежного токена QIWI кошелька в рамках одного `siteId`.
    * `phone` — номер QIWI кошелька покупателя.
    * `accountId` — уникальный идентификатор покупателя в системе ТСП. 
    
    **Указывайте разные параметры `accountId` для разных пользователей, чтобы гарантировать безопасность платежных данных покупателей.**

2. После этого на телефон покупателя придет SMS с одноразовым кодом. Укажите его в запросе завершения выпуска платежного токена QIWI Кошелька.
  
    Отправьте POST-запрос на URL:

    `/partner/payin/v1/sites/{siteId}/token-requests/complete`

    где `{siteId}` — идентификатор siteId мерчанта.

    В JSON-теле запроса укажите параметры:

    * `requestId` — идентификатор из начального запроса инициации выпуска платежного токена.
    * `smsCode` — код из SMS, отправленный покупателю.

В ответе содержатся данные платежного токене:

* `token.value` — строка платежного токена;
* `token.expiredDate` — срок действия платежного токена, в формате `YYYY-MM-DDThh:mm:ss+DMZ`.

<aside class="warning">
Платежный токен будет связан с идентификатором сайта и идентификатором Покупателя, которые вы указали в запросе выпуска платежного токена. Покупатель сможет совершать оплату платежным токеном только на этом сайте.

Чтобы платежный токен действовал на других сайтах одного мерчанта, отправьте запрос в Службу поддержки.
</aside>

## Удаление платежного токена {#delete-payment-token}

> Удаление платежного токена

~~~http
DELETE /partner/payin/v1/sites/test-01/tokens HTTP/1.1
Accept: application/json
Authorization: Bearer 5c4b25xx93aa435d9cb8cd17480356f9
Content-type: application/json
Host: api.qiwi.com

{
   "token": "66aebf5f-098e-4e36-922a-a4107b349a96",
   "customerAccountId": "token324"
}
~~~

Чтобы прекратить действие платежного токена, отправьте запрос DELETE:

`/partner/payin/v1/sites/{siteId}/tokens`

В JSON-теле запроса укажите параметры:

  * `customerAccountId` — уникальный идентификатор покупателя в вашей системе, привязанный к платежному токену.
  * `token` — платежный токен.

Успешный ответ означает, что платежный токен для указанного покупателя больше не действует. 

Этот метод действует как для платежного токена карты, так и для платежного токена QIWI Кошелька.
