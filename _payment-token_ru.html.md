# Платежный токен {#payment-token-issue}

В **Протоколе приема платежей** поддерживается генерация платежных токенов карт и QIWI Кошельков. Они могут быть использованы для последующих списаний без дополнительного ввода реквизитов карт или номера кошелька. При выпуске платежного токена карты ее реквизиты сохраняются в зашифрованном виде в QIWI.

## Особенности {#payment-token-special}

По умолчанию выпуск платежных токенов отключен. Чтобы подключить его, обратитесь к вашему сопровождающему менеджеру.

<aside class="warning">Платежный токен карты выпускается только после успешной авторизации платежа банком-эмитентом.</aside>

Если вы используете Платежную форму QIWI, то обратитесь к вашему сопровождающему менеджеру чтобы включить отображение покупателю списка его карт, привязанных через платежные токены. Только в этом случае покупатель сможет воспользоваться привязанными картами на форме. Список карт будет отображаться только для оплаты с сайта мерчанта, где были созданы токены.

## Выпуск платежного токена карты {#merchant-form-token-issue}

>Пример запроса выставления счета с выпуском платежного токена

~~~http
PUT /partner/payin/v1/sites/23044/bills/893794793973 HTTP/1.1
Accept: application/json
Authorization: Bearer 5c4b25xx93aa435d9cb8cd17480356f9
Content-type: application/json
Host: api.qiwi.com

{
   "amount": {
     "currency": "RUB",
     "value": 10.00
   },
   "expirationDateTime": "2021-04-13T14:30:00+03:00",
    "customer": {
      "account":"token32"
   },
   "customFields": {},
   "flags":["BIND_PAYMENT_TOKEN"]
}
~~~

>Пример запроса платежа с выпуском платежного токена

~~~http
PUT /partner/payin/v1/sites/test-01/payments/test-022 HTTP/1.1
Accept: application/json
Authorization: Bearer 5c4b25xx93aa435d9cb8cd17480356f9
Content-type: application/json
Host: api.qiwi.com

{
   "amount": {
     "currency": "RUB",
     "value": 2211.24
   },
   "customer": {
     "account": "token324",
     "phone": "79022222222"
   },
   "flags":["BIND_PAYMENT_TOKEN"]
}
~~~

> Пример тела ответа с платежным токеном

~~~json
{
    "paymentId": "test-022",
    "billId": "autogenerated-c4479bb1-c916-4fba-8445-802592fa8d51",
    "createdDateTime": "2020-03-26T12:22:12+03:00",
    "amount": {
        "currency": "RUB",
        "value": 2211.24
    },
    "capturedAmount": "..",
    "refundedAmount": "..",
    "paymentMethod": "..",
    "createdToken": {
        "token": "66aebf5f-098e-4e36-922a-a4107b349a96",
        "name": "411111******1111"
    },
    "customer": {
        "account": "token324",
        "phone": "79022222222"
    },
    "status": ".."
}
~~~

Для выпуска платежного токена карты вы можете использовать два способа:

1. Без платежа (предпочтительный способ). Воспользуйтесь запросом [Проверка карты](#how-to-check-card) или [Создание счета с проверкой карты](#how-to-check-card-qiwi-payform). В запросе укажите:
   * параметр `account` — уникальный идентификатор Покупателя в системе ТСП:
     * либо в блоке `tokenizationData` — в случае запроса [Проверка карты](#how-to-check-card);
     * либо в блоке `customer` — в случае запроса [Создание счета](#how-to-check-card-qiwi-payform).
   * параметр `"flags":["CHECK_CARD", "BIND_PAYMENT_TOKEN"]` — в случае запроса [Создание счета](#how-to-check-card-qiwi-payform).

   **Необходимо использовать разные параметры `account` для разных покупателей, чтобы гарантировать безопасность карточных данных покупателей.**

   Вы получите информацию о платежном токене карты после успешного [завершения проверки](#how-to-check-card):

   * В блоке `createdToken` ответа на финальный запрос.
   * В [уведомлении CHECK_CARD](#check-card-callback).

   Также можно запросить [текущий статус проверки](#card-check-info) — в ответе вернется блок `createdToken` с информацией о выпущенном платежном токене.

   Подробнее см. в разделе [Проверка карты покупателя](#check-card).

2. В процессе проведения платежа. Воспользуйтесь запросом [Платеж](#payments) или [Создание счета](#invoice_put). В запросе укажите дополнительные параметры:
   * `"flags": ["BIND_PAYMENT_TOKEN"]` — команда для выпуска платежного токена.
   * `customer.account` — уникальный идентификатор Покупателя в системе ТСП.

   **Необходимо использовать разные параметры `account` для разных покупателей, чтобы гарантировать безопасность карточных данных покупателей.**

   Вы получите информацию о платежном токене карты:

   * В синхронном ответе на запрос API  [Платеж](#payments) в поле `createdToken`.
   * После успешного завершения платежа в [уведомлении](#payment-callback) в поле `tokenData`.

<aside class="warning">
Платежный токен будет связан с идентификатором сайта и идентификатором Покупателя, которые вы указали в запросе API. Покупатель сможет совершать оплату платежным токеном только на этом сайте.

Чтобы платежный токен действовал на других сайтах одного мерчанта, отправьте запрос в Службу поддержки.
</aside>

## Выпуск токена для оплаты через СБП {#merchant-form-token-issue-sbp}

> Пример тела запроса выпуска токена СБП

~~~json
{
  "qrCodeUid": "adghj17d1g8",
  "amount": {
    "value": 100.00,
    "currency": "RUB"
  },
  "qrCode": {
    "type": "TOKEN",
    "image": {
        "mediaType": "image/png",
        "width": "300",
        "height": "300"
      }
  },
  "tokenizationPurpose": "",
  "tokenizationAccount": "3e2322",
  "flags": ["CREATE_TOKEN"]
}
~~~

Вы можете выпустить платежный токен СБП для привязки карты покупателя.

<aside class="notice">
Платежный токен будет связан с идентификатором сайта и идентификатором Покупателя, которые вы указали в запросе API.
</aside>

Чтобы выпустить платежный токен, воспользуйтесь запросом [Получение QR-кода СБП](#qr-code-sbp). В запросе укажите:

* Объект `qrCode` с характеристиками запрашиваемого QR-кода:
   * Тип QR-кода в параметре `qrCode.type` — `TOKEN`.
   * Тип и размер изображения QR-кода в блоке `qrCode.image`.
* Сумму платежа.
* Параметр `tokenizationAccount` — уникальный идентификатор Покупателя в системе ТСП.
* Параметр `"flags":["CREATE_TOKEN"]`.
* Описание токена в параметре `tokenizationPurpose`.

**Необходимо использовать разные параметры `tokenizationAccount` для разных покупателей, чтобы гарантировать безопасность привязанных карточных данных покупателей.**

Вы получите информацию о платежном токене СБП в объекте `token` ответа.

## Выпуск платежного токена QIWI Кошелька {#merchant-form-wallet-token-issue}

>Пример запроса с инициацией выпуска платежного токена QIWI Кошелька

~~~http
POST /partner/payin-tokenization-api/v1/sites/test-01/token-requests HTTP/1.1
Accept: application/json
Authorization: Bearer 5c4b25xx93aa435d9cb8cd17480356f9
Content-type: application/json
Host: api.qiwi.com

{
   "requestId": "asd1232q77w1e3212",
   "phone": "79022222222",
   "accountId": "token324"
}
~~~

> Ответ на запрос

~~~json
{
    "requestId": "asd1232q77w1e3212",
    "status": {
        "value": "WAITING_SMS"
    }
}
~~~

>Пример запроса завершения выпуска платежного токена QIWI Кошелька

~~~http
PUT /partner/payin-tokenization-api/v1/sites/test-01/token-requests/complete HTTP/1.1
Accept: application/json
Authorization: Bearer 5c4b25xx93aa435d9cb8cd17480356f9
Content-type: application/json
Host: api.qiwi.com

{
   "requestId": "asd1232q77w1e3212",
   "smsCode": "1223"
}
~~~

> Ответ на запрос

~~~json
{
    "requestId": "asd1232q77w1e3212",
    "status": {
        "value": "CREATED"
    },
    "token": {
        "value": "589c04b5-47dd-41af-9682-b3eb91",
        "expiredDate": "2021-11-08T14:23:54+03:00"
    }
}
~~~

Чтобы выпустить платежный токен QIWI кошелька, выполните следующие запросы к API:

1. Запрос инициации выпуска платежного токена QIWI Кошелька.

    Отправьте POST-запрос на URL:

    `/payin-tokenization-api/v1/sites/{siteId}/token-requests`

    где `{siteId}` — идентификатор `siteId` мерчанта.

    В JSON-теле запроса укажите параметры:

    * `requestId` — уникальный идентификатор запроса (от 1 до 36 символов). Уникальность означает, что идентификатор должен отличаться от идентификаторов всех ранее созданных запросов ТСП на выпуск платежного токена QIWI кошелька в рамках одного `siteId`.
    * `phone` — номер QIWI кошелька покупателя.
    * `accountId` — уникальный идентификатор покупателя в системе ТСП.

    **Указывайте разные параметры `accountId` для разных покупателей, чтобы гарантировать безопасность платежных данных покупателей.**

2. После этого на телефон покупателя придет SMS с одноразовым кодом. Укажите его в запросе завершения выпуска платежного токена QIWI Кошелька.

    Отправьте POST-запрос на URL:

    `/payin-tokenization-api/v1/sites/{siteId}/token-requests/complete`

    где `{siteId}` — идентификатор `siteId` мерчанта.

    В JSON-теле запроса укажите параметры:

    * `requestId` — идентификатор из начального запроса инициации выпуска платежного токена.
    * `smsCode` — код из SMS, отправленный покупателю.

В ответе содержатся данные платежного токене:

* `token.value` — строка платежного токена;
* `token.expiredDate` — срок действия платежного токена, в формате `YYYY-MM-DDThh:mm:ss+DMZ`.

<aside class="warning">
Платежный токен будет связан с идентификатором сайта и идентификатором Покупателя, которые вы указали в запросе выпуска платежного токена. Покупатель сможет совершать оплату платежным токеном только на этом сайте.

Чтобы платежный токен действовал на других сайтах одного мерчанта, отправьте запрос в Службу поддержки.
</aside>

## Удаление платежного токена {#delete-payment-token}

> Удаление платежного токена

~~~http
DELETE /partner/payin/v1/sites/test-01/tokens HTTP/1.1
Accept: application/json
Authorization: Bearer 5c4b25xx93aa435d9cb8cd17480356f9
Content-type: application/json
Host: api.qiwi.com

{
   "token": "66aebf5f-098e-4e36-922a-a4107b349a96",
   "customerAccountId": "token324"
}
~~~

Чтобы прекратить действие платежного токена, отправьте запрос DELETE:

`/partner/payin/v1/sites/{siteId}/tokens`

В JSON-теле запроса укажите параметры:

* `customerAccountId` — уникальный идентификатор покупателя в вашей системе, привязанный к платежному токену.
* `token` — платежный токен.

Успешный ответ означает, что платежный токен для указанного покупателя больше не действует.

Этот метод действует как для платежного токена карты, так и для платежного токена QIWI Кошелька.
