# Платеж через форму QIWI {#invoicing}

При подключении платежей через форму QIWI покупателю доступен только способ оплаты банковскими картами. Другие способы оплаты включаются по запросу:

* [Платежные токены карт](#qiwi-form-cardtoken).
* Система быстрых платежей.
* QIWI Кошелек.

Чтобы выполнить платеж через форму QIWI, выставите счет покупателю. Воспользуйтесь [выставлением счета через API](#qiwi-form-invoice-api) или перенаправьте покупателя на форму QIWI [по прямой ссылке с параметрами счета](#https-qiwi-form).

## Процесс платежа {#flow-payment-qiwi-form}

<div class="mermaid">
sequenceDiagram
participant customer as Покупатель
participant store as Магазин
participant qb as QIWI (эквайер)
participant ips as Эмитент
customer->>store:Выбор товаров, Старт оплаты
activate store
store->>qb:Выставление счета<br/>Одношаговый платеж — все способы оплаты<br/>Двухшаговый платеж — только карты
activate qb
qb->>store:Ссылка на платежную форму QIWI (payUrl)
store->>customer:Переадресация покупателя на payUrl
customer->>qb:Открытие платежной формы,<br/>выбор способа оплаты,<br/>указание платежных данных для выбранного способа
qb->>customer:Аутентификация покупателя:<br/>Для карт — 3-D Secure
customer->>qb:Аутентификация
qb->>ips:Запрос списания денежных средств
activate ips
ips->>qb:Статус операции
qb->>store:Уведомление о статусе операции
qb->>customer: Переадресация на страницу статуса платежа (successUrl)
rect rgb(237, 243, 255)
Note over store, ips:Двухшаговый платеж
store->>qb:Подтверждение операции (capture)
qb->>ips:Подтверждение списания
deactivate ips
qb->>store:Уведомление о подтверждении платежа
end
deactivate qb
deactivate store
</div>

## Интеграция c Платежной формой QIWI без использования API {#https-qiwi-form}

<aside class="warning">
При использовании этого способа нельзя гарантировать, что все счета выставлены мерчантом, в отличие от выставления по API.
</aside>

Это простой способ интеграции с Платежной формой QIWI. При открытии формы покупателю автоматически выставляется счет. Параметры счета передаются в открытом виде в ссылке на форму. Покупателю отображается платежная форма с выбором способов оплаты.

Для вызова формы в ссылке необходимо указывать ключ `PUBLIC_KEY`. Для каждого `siteId` выпускается уникальный ключ. Ключ можно посмотреть в [Личном кабинете](https://kassa.qiwi.com/service/core/merchants?) в разделе **Настройки**.

При оплате счета, выставленного таким способом, платеж автоматически авторизуется без участия мерчанта. Так как используется двухшаговая схема, то для завершения платежа необходимо выполнить запрос [Подтверждение платежа](#capture) или подтвердить платеж через Личный кабинет.

По умолчанию сервис QIWI ожидает подтверждения платежа в течение 72 часов. По истечении срока выполняется автоматическое подтверждение платежа.

<aside class="notice">
Чтобы уменьшить период ожидания подтверждения платежа или настроить автоотмену платежа обратитесь в Службу поддержки.
</aside>

<h3 class="request method" id="payform_flow">GET → </h3>

> Выставление счета с передачей суммы платежа

~~~shell
https://oplata.qiwi.com/create?publicKey=5nAq6abtyCz4tcDj89e5w7Y5i524LAFmzrsN6bQTQ3ceEvMvCq55ToeErzhvK6rVkQLaCrYUQcYF5QkS8nCrjnPsLQgsLxqrpQgJ7hg2ZHmEHXFjaG8qjvgcep&extras[cf1]=Order_123&extras[cf3]=winnie@pooh.ru&readonly_extras=cf1&comment=some%20comment&amount=100.00
~~~

> Выставление счета без указания суммы платежа (сумму заполняет покупатель)

~~~shell
https://oplata.qiwi.com/create?publicKey=5nAq6abtyCz4tcDj89e5w7Y5i524LAFmzrsN6bQTQ3ceEvMvCq55ToeErzhvK6rVkQLaCrYUQcYF5QkS8nCrjnPsLQgsLxqrpQgJ7hg2ZHmEHXFjaG8qjvgcep&extras[cf1]=Order_123&extras[cf3]=winnie@pooh.ru&readonly_extras=cf1
~~~

<ul class="nestedList url">
    <li><h3>URL <span>https://oplata.qiwi.com/create</span></h3></li>
</ul>

<aside class="notice">
При открытии ссылки на форму в webview на смартфонах Android обязательно включайте <code>settings.setDomStorageEnabled(true).</code>
</aside>

<ul class="nestedList params">
    <li><h3>Параметры</h3><span>В URL указываются параметры счета.</span></li>
</ul>

Параметр        | Описание                                                                                                                                                                                                                                                    | Тип                                                   | Обяз.
----------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------|------
publicKey       | Ключ идентификации мерчанта                                                                                                                                                                                                                                 | String                                                | +
billId          | Уникальный идентификатор счета в системе мерчанта. Генерируется на вашей стороне любым способом как уникальная последовательность букв или цифр, а также символов `_` и `-`. Если не указан, то при каждом переходе по ссылке будет создаваться новый счет. | URL-закодированная строка String(200)                 | -
amount          | Сумма покупки, округленная в меньшую сторону до 2 десятичных знаков (всегда в рублях)                                                                                                                                                                       | Number(6.2)                                           | -
currency        | Код валюты покупки. Возможные значения: `RUB`, `EUR`, `USD`. По умолчанию `RUB`                                                                                                                                                                             | String(3)                                             | -
phone           | Номер телефона покупателя (в международном формате)                                                                                                                                                                                                         | URL-закодированная строка                             | -
email           | E-mail покупателя                                                                                                                                                                                                                                           | URL-закодированная строка                             | -
comment         | Комментарий к счету                                                                                                                                                                                                                                         | URL-закодированная строка String(255)                 | -
successUrl      | URL для переадресации в случае успешной оплаты. Ссылка должна вести на сайт мерчанта.                                                                                                                                                                       | URL-закодированная строка                             | -
extras[cf1]     | Дополнительное поле с произвольной информацией, дополняющей данные счета                                                                                                                                                                                    | URL-закодированная строка                             | -
extras[cf2]     | Дополнительное поле с произвольной информацией, дополняющей данные счета                                                                                                                                                                                    | URL-закодированная строка                             | -
extras[cf3]     | Дополнительное поле с произвольной информацией, дополняющей данные счета                                                                                                                                                                                    | URL-закодированная строка                             | -
extras[cf4]     | Дополнительное поле с произвольной информацией, дополняющей данные счета                                                                                                                                                                                    | URL-закодированная строка                             | -
extras[cf5]     | Дополнительное поле с произвольной информацией, дополняющей данные счета                                                                                                                                                                                    | URL-закодированная строка                             | -
extras[themeCode]     | Дополнительное поле с [кодом стиля Платежной формы](#custom-form)                                                                                                                                                                                    | URL-закодированная строка                             | -
readonly_extras | Список дополнительных полей, которые должны быть недоступны для изменения покупателем на платежной форме                                                                                                                                                    | Строка, разделитель имен полей `,`. Пример: `cf1,cf3` | -

По умолчанию, после оплаты счета автоматически выполняется аутентификация покупателя. Завершение аутентификации также происходит автоматически.

## Выставление счета и получение ссылки на оплату через API {#qiwi-form-invoice-api}

> Выставление счета с оплатой через холдирование (двухшаговый платеж)

~~~http
PUT /partner/payin/v1/sites/23044/bills/893794793973 HTTP/1.1
Accept: application/json
Authorization: Bearer 5c4b25xx93aa435d9cb8cd17480356f9
Content-type: application/json
Host: api.qiwi.com

{
   "amount": {
     "currency": "RUB",
     "value": 42.24
   },
   "billPaymentMethodsType": [
      "QIWI_WALLET",
      "SBP"
   ],
   "comment": "Spasibo",
   "expirationDateTime": "2019-09-13T14:30:00+03:00",
   "customFields": {}
}
~~~

> Выставление счета с оплатой без авторизации Покупателя (одношаговый платеж)

~~~http
PUT /partner/payin/v1/sites/23044/bills/893794793973 HTTP/1.1
Accept: application/json
Authorization: Bearer 5c4b25xx93aa435d9cb8cd17480356f9
Content-type: application/json
Host: api.qiwi.com

{
   "amount": {
     "currency": "RUB",
     "value": 100.00
   },
   "expirationDateTime": "2018-04-13T14:30:00+03:00",
   "flags": [
     "SALE"
    ]
}
~~~

> Уведомление об оплате счета

~~~json
{
  "payment": {
    "type": "PAYMENT",
    "paymentId": "824c7744-1650-4836-abaa-842ca7ca8a74",  <==paymentId, необходимый для подтверждения
    "createdDateTime": "2022-07-27T12:43:35+03:00",
    "status": {
        "value": "SUCCESS",
        "changedDateTime": "2022-07-27T12:43:47+03:00"
    },
    "amount": {
        "value": 1.00,
        "currency": "RUB"
    },
    "paymentMethod": {
        "type": "CARD",
        "maskedPan": "512391******6871",
        "cardHolder": null,
        "cardExpireDate": "3/2030"
    },
    "tokenData": {
        "paymentToken": "cc123da5-2fdd-4685-912e-8671597948a3",
        "expiredDate": "2030-03-01T00:00:00+03:00"
    },
    "customFields": {
        "cf2": "dva",
        "cf1": "1",
        "cf4": "4",
        "cf3": "tri",
        "cf5": "5",
        "full_name": "full_name",
        "phone": "phone",
        "contract_id": "contract_id",
        "comment": "test",
        "booking_number": "booking_number"
    },
    "paymentCardInfo": {
        "issuingCountry": "643",
        "issuingBank": "Тинькофф банк",
        "paymentSystem": "MASTERCARD",
        "fundingSource": "UNKNOWN",
        "paymentSystemProduct": "TNW|TNW|Mastercard® New World—Immediate Debit|TNW|Mastercard New World-Immediate Debit"
    },
    "customer": {
        "email": "darta@mail.ru",
        "account": "11235813",
        "phone": "79850223243"
    },
    "gatewayData": {
        "type": "ACQUIRING",
        "eci": "2",
        "authCode": "0123342",
        "rrn": "001239598011"
    },
    "billId": "191616216126154",
    "flags": [
        "AFT"
    ]
  },
  "type": "PAYMENT",
  "version": "1"
}
~~~

<aside class="warning">
На Платежной форме QIWI по умолчанию покупателю доступен только способ оплаты банковской картой. Для подключения других способов оплаты обратитесь к вашему сопровождающему менеджеру.
</aside>

Протокол приема платежей поддерживает выставление счетов с оплатой как двухшаговым платежом с холдированием средств на карте покупателя, так и одношаговым платежом без авторизации покупателя:

<a name="one_step">

1. Для двухшагового платежа передайте в запросе API [Создание счета](#invoice_put):

   * [ключ API](#api-auth);
   * сумму счета (`amount`);
   * дату, до которой необходимо оплатить счет (`expirationDateTime`);
   * (опционально) другую информацию о счете:
     * комментарий (`comment`);
     * информация о покупателе (`customer`, `address`) и получателе платежа (`receiverData`);
     * дополнительные данные по операции (`customFields`).

   Чтобы выставить счет для оплаты без дополнительной авторизации покупателя (одношаговый платеж), добавьте в запрос API дополнительный параметр `"flags":["SALE"]`. **Если не передать этот параметр, то будет выполнено безусловное холдирование средств для оплаты счета**.

   Вы можете управлять методами платежа, которые будут отображены покупателю на Платежной форме. Для этого перечислите их в параметре API `billPaymentMethodsType`. Методы должны быть включены для `siteId`, указанного в запросе.

2. [Перенаправьте покупателя на Платежную форму](#qiwi-redirect) по ссылке из параметра `payUrl` ответа.
3. Дождитесь завершения платежа: вам придет [уведомление](#payment-callback), или периодически отправляйте запрос API [Статус счета](#invoice-details), чтобы получить информацию о платеже.

<a name="#qiwi-capture">

>Подтверждение платежа

~~~http
PUT /partner/payin/v1/sites/{siteId}/payments/804900/capture/bxwd8096 HTTP/1.1
Accept: application/json
Authorization: Bearer 5c4b25xx93aa435d9cb8cd17480356f9
Content-type: application/json
Host: api.qiwi.com
~~~

Для двухшагового сценария (платеж с холдированием средств) требуется выполнить подтверждение платежа. [Возмещение](#reimburse) формируется только после подтверждения.

<aside class="notice">
По умолчанию, при холдировании сервис QIWI ожидает подтверждения платежа в течение 72 часов. По истечении срока выполняется автоподтверждение платежа. Чтобы увеличить или уменьшить период ожидания, или настроить автоотмену платежа, обратитесь в Службу поддержки. Период ожидания не может длиться более 5 суток.
</aside>

Чтобы подтвердить платеж в двухшаговом сценарии:

1. Получите идентификатор платежа `paymentId`:
   * из [серверного уведомления](#payment-callback). Вы получите его после успешного холдирования средств;
   * из ответа на запрос API [Получение списка платежей по счету](#invoice-payments).
2. Отправьте запрос API [Подтверждение платежа](#capture) с полученным `paymentId`.

### Платежный токен {#qiwi-form-cardtoken}

> Выставление счета с оплатой платежным токеном

~~~http
PUT /partner/payin/v1/sites/test-02/bills/1815 HTTP/1.1
Accept: application/json
Authorization: Bearer 7uc4b25xx93xxx5d9cb8cd17480356f9
Content-type: application/json
Host: api.qiwi.com

{
   "amount": {
     "currency": "RUB",
     "value": 100.00
   },
   "comment": "Text comment",
   "expirationDateTime": "2018-04-13T14:30:00+03:00",
   "customer": {
     "account": "token234"
   },
   "customFields": {
    "cf1": "Some data",
    "FROM_MERCHANT_CONTRACT_ID": "1234"
   }
   }
}
~~~

Платежные токены используются для списаний с карт или QIWI кошельков без ввода реквизитов карты или номера кошелька. Метод оплаты платежным токеном по умолчанию отключен. Чтобы подключить его, обратитесь к вашему сопровождающему менеджеру.

О выпуске платежного токена читайте [в разделе по ссылке](#payment-token-issue).

<aside class="warning">
Покупатель может совершать оплату платежным токеном только на том сайте, для которого был выпущен платежный токен.

Чтобы платежный токен действовал на других сайтах, отправьте запрос в Службу поддержки.
</aside>

Чтобы покупатель смог оплатить платежным токеном:

1. Передайте в запросе API [Создание счета](#invoice_put) следующую информацию:
   * ключ API;
   * сумму счета (`amount`);
   * дату, до которой необходимо оплатить счет (`expirationDateTime`);
   * идентификатор покупателя, для которого был выпущен платежный токен, в параметре `customer.account`. **Без этого параметра оплата платежным токеном невозможна.**
   * (опционально) другую информацию о счете.
2. [Перенаправьте покупателя на Платежную форму](#qiwi-redirect) по ссылке из параметра `payUrl` ответа.
3. Если для покупателя был выпущен один или несколько платежных токенов, то на Платежной форме отобразится список его привязанных карт.

   ![qiwi-form-tokens](/images/qiwi-form-token.png)

   Для оплаты покупателю достаточно выбрать карту из списка. Указывать карточные данные и проходить проверку 3-D Secure не требуется.

Для списания средств по платежному токену без участия Покупателя воспользуйтесь методом API [Платеж](#payment). См. подробнее [описание использования платежного токена на Платежной форме мерчанта](#merchant-token-pay).

## Перенаправление на форму QIWI {#qiwi-redirect}

>Пример ответа с payUrl

~~~http
HTTP/1.1 200 OK
Content-Type: application/json

{
    "siteId": "test-01",
    "billId": "gg",
    "amount": {
        "currency": "RUB",
        "value": 42.24
    },
    "status": {
        "value": "WAITING",
        "changedDateTime": "2019-08-28T16:26:36.835+03:00"
    },
    "customFields": {},
    "comment": "Spasibo",
    "creationDateTime": "2019-08-28T16:26:36.835+03:00",
    "expirationDateTime": "2019-09-13T14:30:00+03:00",
    "payUrl": "https://oplata.qiwi.com/form/?invoice_uid=78d60ca9-7c99-481f-8e51-0100c9012087"
}
~~~

Чтобы покупатель смог оплатить выставленный счет, перенаправьте его на Платежную форму по ссылке из поля `payUrl` ответа на запрос выставления счета.

По умолчанию, на Платежной форме QIWI 3-D Secure покупателя обязателен.

<aside class="notice">
При открытии ссылки на форму в webview на смартфонах Android обязательно включайте <code>settings.setDomStorageEnabled(true)</code>
</aside>

> Пример ссылки с successUrl

~~~shell
https://oplata.qiwi.com/form?invoiceUid=606a5f75-4f8e-4ce2-b400-967179502275&successUrl=https://example.com/payments/#introduction
~~~

К ссылке можно добавить следующий параметр:

| Параметр | Описание | Тип |
|--------------|--------|-------------|
| successUrl | URL для переадресации в случае успешной оплаты. Переадресация произойдет после успешной 3DS аутентификации. Ссылку необходимо зашифровать в utf-8 формат. | URL-закодированная строка |

> Пример обработчика событий iframe

~~~javascript
window.addEventListener('message', function (event) {
    switch (event.data) {
        case 'INITIALIZED':
            // Форма загружена
            break;
        case 'PAYMENT_ATTEMPT':
            // Попытка платежа
            break;
        case 'PAYMENT_SUCCEEDED':
            // Платеж прошел успешно
            break;
        case 'PAYMENT_FAILED':
            // Платеж не прошел
            break;
    }
}, false)
~~~

При открытии ссылки в `<iframe>`:

`<iframe src="<ссылка payUrl> ..." />`

вы можете использовать [метод](https://developer.mozilla.org/ru/docs/Web/API/Window/postMessage) `postMessage` для отслеживания состояния формы. Возможные значения состояния:

* `INITIALIZED` — Форма загружена.
* `PAYMENT_ATTEMPT` — Попытка платежа.
* `PAYMENT_SUCCEEDED` — Платеж прошел успешно.
* `PAYMENT_FAILED` — Платеж не прошел.
* `INITIALIZATION_FAILED` — Ошибка загрузки формы.

## Настройка Платежной формы {#custom-form}

Внешний вид Платежной формы можно настроить в соответствии с вашим стилем, включая лого, фон и цвет кнопок. Для этого обратитесь в [Службу поддержки](mailto:payin@qiwi.com) и предоставьте следующую информацию:

* уникальный псевдоним стиля, привязанный к идентификатору `siteId` (цифры, латинские буквы и символ дефиса `-`);
* название мерчанта, которое будет отображаться на форме;
* краткое описание деятельности (не более 120 символов);
* лого в формате PNG или SVG и размера 310x36 или пропорционально больше;
* цвет фона и цвет кнопок в HEX-формате.

Необязательные данные для настройки:

* картинка для фона в формате PNG или SVG и размера 382x560 или пропорционально больше;
* варианты предвыбранных сумм платежа (не более трех);
* контактный e-mail для отображения на странице;
* URL страницы успешного платежа;
* номер счетчика Яндекс.Метрики;
* ссылка на оферту вашего сервиса.

>Пример передачи параметра стиля при выставлении счета через API

~~~http
PUT /partner/payin/v1/sites/23044/bills/893794793973 HTTP/1.1
Accept: application/json
Authorization: Bearer 5c4b25xx93aa435d9cb8cd17480356f9
Content-type: application/json
Host: api.qiwi.com

{
   "amount": {
     "currency": "RUB",
     "value": 100.00
   },
   "comment": "Text comment",
   "expirationDateTime": "2018-04-13T14:30:00+03:00",
   "customer": {},
   "customFields": {
     "themeCode":"merchant01-theme01"
   }
}
~~~

Чтобы применить ваш стиль на Платежной форме:

* Передайте [при выставлении счета через API](#invoice_put) в поле `"themeCode"` JSON-объекта `customFields` псевдоним стиля, который вы указали при настройке. Например:

   `"themeCode":"merchant01-theme01"`.
* Передайте [в прямом вызове Платежной формы](#https-qiwi-form) в параметре `extras[themeCode]` псевдоним стиля, который вы указали при настройке. Например:

   `...&extras[themeCode]=merchant01-theme01`.

Название псевдонима стиля регистрозависимое.

Пример настройки Платежной формы:

![Customer form](/images/Custom.png)
