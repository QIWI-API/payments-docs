# Серверные уведомления {#callback}

Уведомление от QIWI — входящий POST-запрос с информацией о событии. Тело запроса содержит JSON-сериализованные данные платежа/счета (кодировка UTF-8). 

Протокол поддерживает следующие типы уведомлений о событиях API:

* `PAYMENT` — отправляются при совершении операций платежа, 
* `CAPTURE` — отправляются при совершении операций подтверждения платежа, 
* `REFUND` — отправляются при совершении операций возврата платежа,
* `CHECK_CARD` — отправляются при совершении операций проверки карты.
 
<!-- Уведомление `BILL` отправляется только при использовании [Checkout](#invoicing), как только выставленный счет будет оплачен.-->

<aside class="notice">
Не установлено единого порядка отправки уведомлений разного типа в ходе выполнения одной и той же операции. Порядок может отличаться для разных операций.
</aside>

Адрес вашего сервера для обработки уведомлений указывается в Личном Кабинете на сайте <a href="https://kassa.qiwi.com/">kassa.qiwi.com</a> в разделе **Настройки**. Чтобы указать URL для уведомлений для отдельной операции, используйте параметр `callbackUrl` в запросе к API.

URL для уведомлений должен начинаться с https, так как уведомления отправляются по протоколу HTTPS на порт 443.
Сертификат сайта должен быть выпущен доверенным центром сертификации (например Comodo, Verisign, Thawte и т.п.).

<aside class="notice">
Если уведомление об операции не поступило вам в течение 10 минут после совершения операции, необходимо запросить статус операции <a href="#invoice_get">запросом статуса счета</a> или <a href="#payment_get">запросом статуса платежа</a> (в зависимости от того, какой из <a href="#methods">способов взаимодействия</a> вы используете).
</aside>

Для дополнительной уверенности следует принимать уведомления о платежах только с указанных ниже IP-адресов компании QIWI:

* 79.142.16.0/20
* 195.189.100.0/22
* 91.232.230.0/23
* 91.213.51.0/24

Уведомление считается успешно доставленным, если ваш сервер ответил HTTP кодом состояния `200 OK`.
До этого момента система будет пытаться доставить уведомление через увеличивающиеся интервалы времени в течение суток с момента операции.

<aside class="success">
Если по какой-либо причине ваш сервер успешно обработал уведомление по транзакции, но не вернул <code>200 OK</code>, то при повторной попытке доставки не нужно обрабатывать данную транзакцию как новую.
</aside>

## Авторизация уведомлений {#notifications_auth}

В уведомлении присутствует цифровая подпись запроса, которую необходимо проверять на вашей стороне для исключения возможности подделки уведомления.

<aside class="warning">
Вся ответственность за возможные финансовые потери, случившиеся вследствие отсутствия валидации подписи в нелегитимном уведомлении, лежит полностью на мерчанте.
</aside>

Цифровая подпись уведомления помещается в HTTP-заголовок `Signature`.

<!--
Тип уведомлений| HTTP-заголовок с подписью
----|-----
`PAYMENT`, `CAPTURE`, `REFUND` | `Signature`
`BILL` | `X-Api-Signature-SHA256`
-->

Для проверки подписи используется механизм проверки целостности HMAC с хэш-функцией SHA256.

Алгоритм проверки подписи:

1. Объединить значения определенных параметров в одну строку с разделителем "\|". Например:

   `parameters = {payment.paymentId}|{payment.createdDateTime}|{payment.amount.value}`

   где `{*}` – значение параметра уведомления. Все значения при проверке подписи должны трактоваться как строки.

   Подпись считается для следующих полей уведомления:

     * тип `PAYMENT`: `payment.paymentId|payment.createdDateTime|payment.amount.value`
     * тип `REFUND`: `refund.refundId|refund.createdDateTime|refund.amount.value`
     * тип `CAPTURE`: `capture.captureId|capture.createdDateTime|capture.amount.value`
     * тип `CHECK_CARD`: `checkPaymentMethod.requestUid|checkPaymentMethod.checkOperationDate`

2. Вычислить HMAC-хэш c алгоритмом хэширования SHA256:

   `hash = HMAС(SHA256, token, parameters)`

   Где:

      * `token` — ключ хэширования (UTF-8). Совпадает с [ключом доступа к API](#auth), использованном в исходном запросе к API на операцию.
      * `parameters` — строка из п.1 (UTF-8).

3. Сравнить значение подписи из  HTTP-заголовка `Signature` уведомления с результатом п.2.


## Формат уведомления {#payment_callback}

<ul class="nestedList header">
    <li><h3>HEADERS</h3>
        <ul>
             <li>Signature: XXX</li>
             <li>Accept: application/json</li>
             <li>Content-type: application/json</li>
        </ul>
    </li>
</ul>

> Пример уведомления

~~~http
POST /qiwi-notify.php HTTP/1.1
Accept: application/json
Content-type: application/json
Signature: J4WNfNZd***V5mv2w=
Host: server.ru

{
   "payment":{
      "paymentId":"4504751",
      "tokenData":{
         "paymentToken":"4cc975be-483f-8d29-2b7de3e60c2f",
         "expiredDate":"2021-12-31T00:00:00+03:00"
      },
      "type":"PAYMENT",
      "createdDateTime":"2019-10-08T11:31:37+03:00",
      "status":{
         "value":"SUCCESS",
         "changedDateTime":"2019-10-08T11:31:37+03:00"
      },
      "amount":{
         "value":2211.24,
         "currency":"RUB"
      },
      "paymentMethod":{
         "type":"CARD",
         "maskedPan":"220024/*/*/*/*/*/*5036",
         "rrn":null,
         "authCode":null,
         "type":"CARD"
      },
      "paymentCardInfo": {
         "issuingCountry": "810",
         "issuingBank": "QiwiBank",
         "paymentSystem": "VISA",
         "fundingSource": "CREDIT",
         "paymentSystemProduct": "P|Visa Gold"
      },
      "customer":{
         "ip":"79.142.20.248",
         "account":"token32",
         "phone":"0"
      },
      "billId":"testing122",
      "customFields":{},
      "flags":[
         "SALE"
      ]
   },
   "type":"PAYMENT",
   "version":"1"
}
~~~



Поле|Описание|Тип|В каких уведомлениях используется
--------|--------|---|------
payment | Описание платежа. | Object | В уведомлениях PAYMENT
refund | Описание возврата. | Object | В уведомлениях REFUND
capture | Описание подтверждения. | Object | В уведомлениях CAPTURE
checkPaymentMethod | Описание результата проверки карты | Object | В уведомлениях CHECK_CARD
----|------|-------|--------
type| [Тип операции](#operation-types) |String(200)| Во всех уведомлениях, кроме CHECK_CARD
paymentId|Уникальный идентификатор платежа в системе ТСП.|String(200)|В уведомлениях PAYMENT
refundId|Уникальный идентификатор возврата в системе ТСП.|String(200)|В уведомлениях REFUND
captureId|Уникальный идентификатор подтверждения в системе ТСП.|String(200)|В уведомлениях CAPTURE
createdDatetime | Дата создания операции | URL-закодированная строка<br>`ГГГГ-ММ-ДДTЧЧ:ММ:ССZ`|Во всех уведомлениях, кроме CHECK_CARD
checkOperationDate | Дата проверки карты | URL-закодированная строка<br>`ГГГГ-ММ-ДДTЧЧ:ММ:ССZ`|В уведомлениях CHECK_CARD
requestUid | Идентификатор [операции проверки карты](#check-card) | String | В уведомлениях CHECK_CARD
amount | Информация о сумме операции |Object|Во всех уведомлениях, кроме CHECK_CARD
--|--|----|---
value | Сумма операции, округленная до двух десятичных знаков в меньшую сторону | Number(6.2)|Во всех уведомлениях
currency | Идентификатор валюты операции (Alpha-3 ISO 4217 код) | String(3)|Во всех уведомлениях
---|---|---|----
billId| ID счета, соответствующего операции| String(200)|Во всех уведомлениях, кроме CHECK_CARD
status | Информация о статусе операции | Object|Во всех уведомлениях, кроме CHECK_CARD
---|---|---|------
value |Строковое значение статуса | String|Во всех уведомлениях
changedDatetime|Дата обновления статуса| URL-закодированная строка<br>`ГГГГ-ММ-ДДTЧЧ:ММ:ССZ`|Во всех уведомлениях
reasonCode| [Код причины отклонения](#reason-codes)| String(200)|Во всех уведомлениях
reasonMessage| Описание причины отклонения| String(200)|Во всех уведомлениях
errorCode| Код ошибки| Number|Во всех уведомлениях
---|---|---|------
status | Информация о статусе проверки карты | String|В уведомлениях CHECK_CARD
isValidCard | Признак валидности карты | Bool|В уведомлениях CHECK_CARD
threeDsStatus | Информация о статусе дополнительной аутентификации при проверке карты | String|В уведомлениях CHECK_CARD. Возможные значения —  `PASSED` (3-D Secure пройден), `NOT_PASSED` (3-D Secure не пройден), `WITHOUT` (3-D Secure не требовалось)
paymentMethod| Информация о средстве платежа| Object|Во всех уведомлениях
---|---|---|------
type| Тип метода оплаты| String|Во всех уведомлениях
paymentToken| Платежный токен карты.| String |  В уведомлениях PAYMENT при оплате платежным токеном
maskedPan| Маскированный PAN карты| String|Во всех уведомлениях
rrn| RRN платежа (по ISO 8583)| Number|Во всех уведомлениях, кроме CHECK_CARD
authCode| Auth-code платежа| Number|Во всех уведомлениях, кроме CHECK_CARD
cardExpireDate | Срок действия карты | String|В уведомлениях CHECK_CARD
cardHolder | Имя держателя карты | String|В уведомлениях CHECK_CARD
paymentCardInfo | Информация о карте.| Object |  В уведомлениях PAYMENT
cardInfo | Информация о карте.| Object |  В уведомлениях CHECK_CARD
---|---|---|-------
issuingCountry | Код страны эмитента | String(3)|В уведомлениях PAYMENT, CHECK_CARD
issuingBank | Банк-эмитент | String|В уведомлениях PAYMENT, CHECK_CARD
paymentSystem | Тип платежной системы | String|В уведомлениях PAYMENT, CHECK_CARD
fundingSource | Тип карты | String |В уведомлениях PAYMENT, CHECK_CARD
paymentSystemProduct | Категория карты | String|В уведомлениях PAYMENT, CHECK_CARD
---|---|---|-----
customer | Информация о пользователе, на которого был выставлен счет| Object|Во всех уведомлениях
---|---|---|------
phone |Номер телефона, на который был выставлен счет (если был указан при выставлении счета) |String|Во всех уведомлениях
email|E-mail пользователя (если был указан при выставлении счета)|String|Во всех уведомлениях
account| Идентификатор пользователя в системе ТСП (если был указан при выставлении счета)|String|Во всех уведомлениях
ip| IP адрес пользователя |String|Во всех уведомлениях
country| Страна адреса пользователя |String|Во всех уведомлениях
---|---|---|----
customFields | Поля с произвольной информацией, дополняющей данные по операции | Object|Во всех уведомлениях
---|---|---|-----
cf1 | Поле с произвольной информацией, дополняющей данные по операции| String(256)|Во всех уведомлениях
cf2 | Поле с произвольной информацией, дополняющей данные по операции| String(256)|Во всех уведомлениях
cf3 | Поле с произвольной информацией, дополняющей данные по операции| String(256)|Во всех уведомлениях
cf4 | Поле с произвольной информацией, дополняющей данные по операции| String(256)|Во всех уведомлениях
cf5 | Поле с произвольной информацией, дополняющей данные по операции| String(256)|Во всех уведомлениях
`FROM_MERCHANT_CONTRACT_ID`| Номер договора |String(256)|Во всех уведомлениях
`FROM_MERCHANT_BOOKING_NUMBER` | Номер бронирования  |String(256)|Во всех уведомлениях
`FROM_MERCHANT_PHONE` | Мобильный телефон покупателя | String(256)|Во всех уведомлениях
`FROM_MERCHANT_FULL_NAME` | ФИО покупателя |String(256)|Во всех уведомлениях
---|---|---|------|-----
flags| Дополнительные команды, переданные в API| Массив. Возможные элементы - `SALE`/`REVERSAL`|Во всех уведомлениях
tokenData| Объект с информацией о выпущенном [платежном токене](#token_issue)|Object|В уведомлениях PAYMENT, если был запрошен выпуск платежного токена
---|---|---|-----
paymentToken| Строка платежного токена | String|В уведомлениях PAYMENT, если был запрошен выпуск платежного токена
expiredDate | Дата окончания срока действия платежного токена. Формат даты соответствует стандарту ISO-8601:<br>`YYYY-MM-DDThh:mm:ss±hh:mm` | String|В уведомлениях PAYMENT, если был запрошен выпуск платежного токена
---|---|---|-----
createdToken| Объект с информацией о выпущенном [платежном токене](#token_issue)|Object|В уведомлениях CHECK_CARD, если был запрошен выпуск платежного токена при [проверке карты](#check-card)
---|---|---|-----
token| Строка платежного токена | String|В уведомлениях CHECK_CARD, если был запрошен выпуск платежного токена
name |Маскированный PAN карты, для которой выпущен платежный токен| String|В уведомлениях CHECK_CARD, если был запрошен выпуск платежного токена
expiredDate | Дата окончания срока действия платежного токена. Формат даты соответствует стандарту ISO-8601:<br>`YYYY-MM-DDThh:mm:ss±hh:mm` | String|В уведомлениях CHECK_CARD, если был запрошен выпуск платежного токена
account| Идентификатор пользователя, указанный при выпуске платежного токена|String|В уведомлениях CHECK_CARD, если был запрошен выпуск платежного токена
---|---|---|-----
paymentSplits | Описание сплитованных платежей. | Array(Objects) | В уведомлениях PAYMENT по [сплитованным платежам](#payments_split)
-----|------|------|-----
type | Тип передаваемых данных. Всегда строка `MERCHANT_DETAILS` | String|В уведомлениях PAYMENT по [сплитованным платежам](#payments_split)
siteUid | [ID поставщика](#split-boarding) | String|В уведомлениях PAYMENT по [сплитованным платежам](#payments_split)
splitAmount | Данные о возмещении поставщику | Object|В уведомлениях PAYMENT по [сплитованным платежам](#payments_split)
----|----|-----|-----
value | Сумма возмещения | Number|В уведомлениях PAYMENT по [сплитованным платежам](#payments_split)
currency | Буквенный код валюты возмещения по ISO | String(3)|В уведомлениях PAYMENT по [сплитованным платежам](#payments_split)
----|----|-----|-----
splitCommissions | Данные о комиссии | Object|В уведомлениях PAYMENT по [сплитованным платежам](#payments_split)
-----|----|-----|-----
merchantCms | Данные о комиссии с поставщика | Object|В уведомлениях PAYMENT по [сплитованным платежам](#payments_split)
----|-----|----|-----
value | Сумма комиссии | Number|В уведомлениях PAYMENT по [сплитованным платежам](#payments_split)
currency |Буквенный код валюты комиссии по ISO | String(3)|В уведомлениях PAYMENT по [сплитованным платежам](#payments_split)
-----|-----|-----|-----
orderId | Номер заказа | String|В уведомлениях PAYMENT по [сплитованным платежам](#payments_split)
comment | Комментарий к заказу | String|В уведомлениях PAYMENT по [сплитованным платежам](#payments_split)
-----|-----|-----|-----
refundSplits | Описание возвратов по сплитованным платежам. | Array(Objects) | В  уведомлениях REFUND по [возвратам сплитованных платежей](#split-refund)
-----|------|------|-----
type | Тип передаваемых данных. Всегда строка `MERCHANT_DETAILS` | String|В  уведомлениях REFUND по [возвратам сплитованных платежей](#split-refund)
siteUid | [ID поставщика](#split-boarding) | String|В  уведомлениях REFUND по [возвратам сплитованных платежей](#split-refund)
splitAmount | Данные об отмене возмещения поставщику | Object|В  уведомлениях REFUND по [возвратам сплитованных платежей](#split-refund)
----|----|-----|-----
value | Сумма отмены возмещения | Number|В  уведомлениях REFUND по [возвратам сплитованных платежей](#split-refund)
currency | Буквенный код валюты отмены возмещения по ISO | String(3)|В  уведомлениях REFUND по [возвратам сплитованных платежей](#split-refund)
----|----|-----|-----
splitCommissions | Данные о комиссии | Object|В  уведомлениях REFUND по [возвратам сплитованных платежей](#split-refund)
-----|----|-----|-----
merchantCms | Данные о комиссии с поставщика | Object|В  уведомлениях REFUND по [возвратам сплитованных платежей](#split-refund)
----|-----|----|-----
value | Сумма комиссии | Number|В  уведомлениях REFUND по [возвратам сплитованных платежей](#split-refund)
currency |Буквенный код валюты комиссии по ISO | String(3)|В  уведомлениях REFUND по [возвратам сплитованных платежей](#split-refund)
-----|-----|-----|-----
orderId | Номер заказа | String|В  уведомлениях REFUND по [возвратам сплитованных платежей](#split-refund)
comment | Комментарий к заказу | String|В  уведомлениях REFUND по [возвратам сплитованных платежей](#split-refund)
-----|-----|-----|-----
type| Тип уведомления|String(200)|Во всех уведомлениях
version | Версия уведомлений | String|Во всех уведомлениях

## Частота отправки уведомлений {#notification-rate}

Сервис отправки уведомлений распределяет неуспешные уведомления по очередям:

* 1 попытка с отложенным временем 5 секунд
* 1 попытка с отложенным временем 1 минута
* 3 попытки с отложенным временем по 5 минут

Время повторной отправки может сдвигаться в бОльшую сторону.



<!--
--===< NOTIFICATION_STRUCTURE >===--
{
  :
  {
    "paymentId/refundId/captureId":"9999999",
    "createdDateTime":"2019-06-03T08:19:16+03:00",
    "status":{
      "value":"SUCCESS/WAITING/DECLINE",
      "changedDateTime":"2019-06-03T08:19:16+03:00",
      "reasonCode":"payin.gateway.acquiring.declined-fraud",
      "reasonMessage":"Declined by fraud",
      "errorCode":"1234"
    },
    "amount":{
      "value":111.11,
      "currency":"RUB"},
    "paymentMethod": <PAYMENT_METHOD>,
    "customer":{
      "ip":"xxx.xxx.xxx.xxx",
      "email":"my_mail@mail.com",
      "account":"dasd32d2d2",
      "phone":"79991112233",
      "country":"Russian Federation",
      "city":"some city",
      "region":"some region"
    },
    "gatewayData": <GATEWAY_DATA>,
    "billId":"f1e1a1f11ae111a11a111111e1111111",
    "flags":["SALE/REVERSAL"]
  },
  "type":"PAYMENT/REFUND/CAPTURE",
  "version":"1"
}




--===< PAYMENT_METHOD >===--
"paymentMethod":{
  "type":"CARD",
  "maskedPan":"411111\*\*\*\*\*\*0001"
}
"paymentMethod":{
  "type":"QIWI_WALLET",
  "phone":"79991112233"
}
"paymentMethod":{
  "type":"SAVED_CARD",
  "token":"12341234123412341234"
}
"paymentMethod":{
  "type":"MOBILE_COMMERCE",
  "phone":"79991112233"
}
-->
