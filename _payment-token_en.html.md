# Payment Token {#payment-token-issue}

In **Payment protocol** card and QIWI Wallet payment tokens generation is supported. The tokens can be used for debiting cards or QIWI Wallet without entering card/wallet details. On issuing payment token, card details are stored securely on QIWI side.

## Features {#payment-token-special}

By default, the issue of payment tokens is disabled. Contact your Support manager to enable that.

<aside class="warning">Card payment token is issued only after the successful payment  authorization by the issuer bank.</aside>

## Card payment token issue {#merchant-form-token-issue}

>Example of request with invoice and payment token issue

~~~http
PUT /partner/payin/v1/sites/23044/bills/893794793973 HTTP/1.1
Accept: application/json
Authorization: Bearer 5c4b25xx93aa435d9cb8cd17480356f9
Content-type: application/json
Host: api.qiwi.com

{
   "amount": {  
     "currency": "RUB",  
     "value": 10.00
   },
   "expirationDateTime": "2021-04-13T14:30:00+03:00",
    "customer": { 
      "account":"token32" 
   }, 
   "customFields": {}, 
   "flags":["BIND_PAYMENT_TOKEN"] 
} 
~~~

>Example of payment request with payment token issue

~~~http
PUT /partner/payin/v1/sites/test-01/payments/test-022 HTTP/1.1
Accept: application/json
Authorization: Bearer 5c4b25xx93aa435d9cb8cd17480356f9
Content-type: application/json
Host: api.qiwi.com

{
   "amount": {  
     "currency": "RUB",  
     "value": 2211.24
   },
   "customer": {
   	"account": "token324",
    "phone": "79022222222"
   },
   "flags":["BIND_PAYMENT_TOKEN"]
}
~~~

>Example of response with payment token

~~~json
{
    "paymentId": "test-022",
    "billId": "autogenerated-c4479bb1-c916-4fba-8445-802592fa8d51",
    "createdDateTime": "2020-03-26T12:22:12+03:00",
    "amount": {
        "currency": "RUB",
        "value": 2211.24
    },
    "capturedAmount": "..",
    "refundedAmount": "..",
    "paymentMethod": "..",
    "createdToken": {
        "token": "66aebf5f-098e-4e36-922a-a4107b349a96",<= payment token
        "name": "411111******1111"
    },
    "customer": {
        "account": "token324",
        "phone": "79022222222"
    },
    "status": ".."
}
~~~

To issue a payment token, you may use one of the following methods:

1. Without payment (preferred method). Use API request [Card verification](#how-to-check-card) or [Invoice issuing](#how-to-check-card-qiwi-payform). Include the following extra parameters:
   * `account` field with a unique customer ID in the RSP system:
     * either in `tokenizationData` object, in case of [Card verification](#how-to-check-card) request;
     * or in `customer` object, in case of [Invoice issuing](#how-to-check-card-qiwi-payform) request.
   * `"flags":["CHECK_CARD", "BIND_PAYMENT_TOKEN"]` field, in case of [Invoice issuing](#how-to-check-card-qiwi-payform) request.
  
   **Put different `account` values for different users to ensure the security of customers' card data.**

   You will receive the card payment token details after [complete card verification](#how-to-check-card):

   * In the  `createdToken` field of the final response.
   * In the [CHECK_CARD notification](#check-card-callback).

   You can always request a [card verification status](#card-check-info) — in the response you will receive a `createdToken` object with payment token details.

   See [Customer Card Verification](#check-card) section for details.

2. During payment process. Include additional options in the API request [Payment](#payments) or [Invoice](#invoice_put), depending on which API you use:
   * `"flags": ["BIND_PAYMENT_TOKEN"]` is a flag for issuing a payment token.
   * `customer.account` is a unique customer ID in the RSP system.
  
   **Put different `account` values for different users to ensure the security of customers' card data.**

   You will receive the card payment token details:

   * In the synchronous response to the payment request in the `createdToken` field.
   * In the [PAYMENT notification](#payment-callback) after payment is completed successfully, in the `tokenData` field.

<aside class="warning">
The payment token is linked with the site ID and the customer ID that you have specified in the original API request. The customer will be able to make payment by payment token only on this site.

To make the payment token valid on other sites of the same merchant, send a request to Support.
</aside>

## QIWI Wallet payment token issue {#merchant-form-wallet-token-issue}

>Example of a request with QIWI Wallet payment token issue initiation

~~~http
POST /partner/payin-tokenization-api/v1/sites/test-01/token-requests HTTP/1.1
Accept: application/json
Authorization: Bearer 5c4b25xx93aa435d9cb8cd17480356f9
Content-type: application/json
Host: api.qiwi.com

{
   "requestId": "asd1232q77w1e3212",
   "phone": "79022222222",
   "accountId": "token324"
}
~~~

> Response

~~~json
{
    "requestId": "asd1232q77w1e3212",
    "status": {
        "value": "WAITING_SMS"
    }
}
~~~

>Example of a request with providing QIWI Wallet payment token

~~~http
PUT /partner/payin-tokenization-api/v1/sites/test-01/token-requests/complete HTTP/1.1
Accept: application/json
Authorization: Bearer 5c4b25xx93aa435d9cb8cd17480356f9
Content-type: application/json
Host: api.qiwi.com

{
   "requestId": "asd1232q77w1e3212",
   "smsCode": "1223"
}
~~~

> Response

~~~json
{
    "requestId": "asd1232q77w1e3212",
    "status": {
        "value": "CREATED"
    },
    "token": {
        "value": "589c04b5-47dd-41af-9682-b3eb91",<= payment token
        "expiredDate": "2021-11-08T14:23:54+03:00"
    }
}
~~~

To issue a QIWI Wallet payment token, make the following API requests:

1. Requesting the initiation of the QIWI Wallet's payment token issue.
  
    Make POST request to the URL:

    `/payin-tokenization-api/v1/sites/{siteId}/token-requests`

    where `{siteId}` — merchant `siteId` identifier.

    In the JSON-body of the request specify the parameters:

    * `requestId` — a unique query identifier (1 to 36 characters). The uniqueness means that the ID should differ from the identifiers of all previously created RSP requests for the issue of a payment token within one `siteId`.
    * `phone` — QIWI Wallet number of the customer.
    * `accountId` — unique customer identifier in your system. **Put different `accountId` values for different users to ensure the security of customers' payment data.**

2. A one-time SMS will be sent to the customer's phone. Include it in the following request to complete the issue of the payment token of the wallet.
  
    Make POST request to the URL:

    `/payin-tokenization-api/v1/sites/{siteId}/token-requests/complete`

    where `{siteId}` — merchant `siteId` identifier.

    In the JSON-body of the request specify the parameters:

    * `requestId` — the identifier from the initiation request for payment token issue.
    * `smsCode` — a code from SMS sent to the customer.

In response, you get payment token data:

* `token.value` — a QIWI Wallet payment token
* `token.expiredDate` — expiration date of a payment token, in `YYYY-MM-DDThh:mm:ss+DMZ` format.

<aside class="warning">
The payment token is linked with the site ID and the customer ID that you have specified in the original payment request. The customer will be able to make payment by payment token only on this site.

To make the payment token valid on other sites of the same merchant, send a request to Support.
</aside>

## Removal of the payment token {#delete-payment-token}

> Delete payment token

~~~http
DELETE /partner/payin/v1/sites/test-01/tokens HTTP/1.1
Accept: application/json
Authorization: Bearer 5c4b25xx93aa435d9cb8cd17480356f9
Content-type: application/json
Host: api.qiwi.com

{
   "token": "66aebf5f-098e-4e36-922a-a4107b349a96",
   "customerAccountId": "token324"
}
~~~

The method disables a payment token. It applies both to the card payment token and the QIWI wallet payment token.

To disable a payment token, make a DELETE request to the URL:

`/partner/payin/v1/sites/{siteId}/tokens`

In the JSON-body of the request specify the parameters:

* `customerAccountId` is a unique customer ID in your system linked to a payment token.
* `token` is a payment token to stop.

A successful response means that the payment token for the specified customer is no longer valid.
